{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Amigos - Backstage</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/main.css' %}">
  <link rel="stylesheet" href="{% static 'css/movies.css' %}">
  <link rel="stylesheet" href="{% static 'css/friends.css' %}">
  <link rel="stylesheet" href="{% static 'css/mobile.css' %}">
</head>
<body>
  {% include 'backstage/_mobile_header.html' %}
    <header class="site-header">
    <div class="container">
      <nav class="nav-primary">
        <a class="brand" href="{% url 'backstage:index' %}">
            <img src="{% static 'images/Logo_Backstage_branca.png' %}"
                 alt="Backstage Logo"
                 width="250">
        </a>

        <div class="nav-menu">
          <a href="{% url 'backstage:index' %}" class="nav-link">Início</a>
          <a href="{% url 'backstage:amigos' %}" class="nav-link active">Amigos</a>
          <a href="{% url 'backstage:movies' %}" class="nav-link">Filmes</a>
          <a href="{% url 'backstage:series' %}" class="nav-link">Séries</a>
          <a href="{% url 'backstage:lists' %}" class="nav-link">Listas</a>
          <a href="{% url 'backstage:comunidade' %}" class="nav-link">Comunidade</a>
        </div>

        <div class="nav-actions">
          <form method="get" action="{% url 'backstage:buscar' %}" class="search-container">
            <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none">
              <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
              <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <input type="search" name="q" class="search-input" placeholder="Buscar filmes, séries..." autocomplete="off" />
            <input type="hidden" name="tipo" value="titulo" />
            <div class="search-suggestions"></div>
          </form>

          <div class="filter-controls header-filter-controls">
            <button type="button" class="filter-btn" id="filterBtn" aria-label="Filtros">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                <path d="M3 4h18l-7 8v6l-4 2v-8L3 4z" stroke="currentColor" stroke-width="2"/>
              </svg>
            </button>

            <div class="filter-popup" id="filterPopup">
              <div class="filter-content">
                <h3>Filtros de busca</h3>
                <form method="get" action="{% url 'backstage:buscar' %}">
                  <select name="tipo" id="tipoSelect">
                    <option value="">Escolha o tipo de filtro</option>
                    <option value="titulo">Título</option>
                    <option value="genero">Gênero</option>
                    <option value="ano">Ano</option>
                  </select>
                  <div id="filtroAno" style="display:none;">
                    <label for="anoInput">Ano:</label>
                    <input type="number" name="ano" placeholder="Ex: 2024" id="anoInput">
                  </div>
                  <div id="filtroGenero" style="display:none;">
                    <label for="generoSelect">Gênero:</label>
                    <select name="genero" id="generoSelect">
                      <option value="">Selecione um gênero</option>
                      <option value="Ação">Ação</option>
                      <option value="Aventura">Aventura</option>
                      <option value="Comédia">Comédia</option>
                      <option value="Drama">Drama</option>
                      <option value="Fantasia">Fantasia</option>
                      <option value="Ficção Científica">Ficção Científica</option>
                      <option value="Romance">Romance</option>
                      <option value="Suspense">Suspense</option>
                      <option value="Terror">Terror</option>
                      <option value="Animação">Animação</option>
                      <option value="Documentário">Documentário</option>
                    </select>
                  </div>
                  <button type="submit">Aplicar filtros</button>
                </form>
              </div>
            </div>
          </div>

          <button class="icon-btn notification-btn" aria-label="Notificações">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="M12 2a7 7 0 0 1 7 7c0 5.25 1.5 6.75 1.5 6.75H3.5S5 14.25 5 9a7 7 0 0 1 7-7z" stroke="currentColor" stroke-width="2"/>
              <path d="M10.5 19a1.5 1.5 0 0 0 3 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <span class="notification-badge">3</span>
          </button>

          {% if user.is_authenticated %}
          <div class="user-menu">
            <button class="user-avatar" id="userMenuBtn" aria-expanded="false" aria-haspopup="true" aria-label="Menu do usuário">
              <img src="https://yt3.googleusercontent.com/BfPo-vPga13k-FNXBAXodrt2dpt-9iLhmqz3L9_BcMwxxImYOcJdRAr3xFIZdM35g0xQAEfSCBI=s900-c-k-c0x00ffffff-no-rj" alt="Avatar do usuário" />
            </button>
            
            <!-- Letterboxd-Style Dropdown Menu -->
            <div class="user-dropdown" id="userDropdown" role="menu">
              <div class="user-dropdown-header">
                <img src="https://yt3.googleusercontent.com/BfPo-vPga13k-FNXBAXodrt2dpt-9iLhmqz3L9_BcMwxxImYOcJdRAr3xFIZdM35g0xQAEfSCBI=s900-c-k-c0x00ffffff-no-rj" alt="Avatar" class="user-dropdown-avatar" />
                <div class="user-dropdown-info">
                  <p class="user-dropdown-name">{{ user.username|default:"Visitante" }}</p>
                  <p class="user-dropdown-email">{{ user.email|default:"visitante@backstage.com" }}</p>
                </div>
              </div>
              
              <div class="user-dropdown-divider"></div>
              
              <a href="{% url 'backstage:index' %}" class="user-dropdown-item" role="menuitem" tabindex="0">
                <img src="{% static 'images/User.png' %}" alt="Perfil" width="18" height="18" style="filter: brightness(0) invert(1); opacity: 0.7;">
                Perfil
              </a>
              
              <a href="{% url 'backstage:diary' %}" class="user-dropdown-item" role="menuitem" tabindex="0">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                  <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Meu Diário
              </a>
              
              <a href="{% url 'backstage:index' %}" class="user-dropdown-item" role="menuitem" tabindex="0">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                  <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Reviews
              </a>
              
              <a href="{% url 'backstage:lists' %}" class="user-dropdown-item" role="menuitem" tabindex="0">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                  <line x1="8" y1="6" x2="21" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <line x1="8" y1="12" x2="21" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <line x1="8" y1="18" x2="21" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <line x1="3" y1="6" x2="3.01" y2="6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <line x1="3" y1="12" x2="3.01" y2="12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <line x1="3" y1="18" x2="3.01" y2="18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Listas
              </a>
              
              <a href="{% url 'backstage:index' %}" class="user-dropdown-item" role="menuitem" tabindex="0">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                  <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Watchlist
              </a>
              
              <a href="{% url 'backstage:favoritos' %}" class="user-dropdown-item" role="menuitem" tabindex="0">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 29 39" fill="none" style="opacity: 0.7;">
                  <path d="M1.72505 34.5051L2.05744 35.7208C2.11819 35.943 2.2334 36.1465 2.39265 36.3129C2.95883 36.9045 3.91204 36.8782 4.44466 36.2561L13.7613 25.3749C14.1532 24.9172 14.8579 24.9075 15.2622 25.3542L24.3211 35.3616C25.1134 36.2368 26.5154 36.1413 27.1816 35.1667C27.389 34.8632 27.5 34.5042 27.5 34.1366V18.3989V14.0676C27.5 12.889 27.2916 11.7196 26.8845 10.6136L26.4758 9.50293C26.0782 8.42285 25.4972 7.4195 24.7584 6.53707L24.1058 5.75772C23.7691 5.35564 23.4013 4.98067 23.0059 4.63627L22.5401 4.2307C21.9488 3.71572 21.2989 3.27209 20.6039 2.90895L20.3611 2.7821C19.4918 2.32788 18.5603 2.00403 17.5967 1.82094L16.8325 1.67575C15.9318 1.50461 15.0118 1.45815 14.0984 1.53769L12.8183 1.64917C11.9926 1.72107 11.1791 1.89534 10.3964 2.16798L9.13134 2.60864C8.16615 2.94485 7.25821 3.42703 6.43916 4.03839L6.06743 4.31586C5.62325 4.64741 5.2074 5.01531 4.82418 5.41577L4.55395 5.69815C4.03629 6.23911 3.58102 6.8365 3.19669 7.47908L3.05731 7.71213C2.45709 8.71569 2.03754 9.81675 1.81773 10.9653L1.67827 11.6939C1.55969 12.3135 1.5 12.9429 1.5 13.5737V30.6254V32.8286C1.5 33.395 1.57569 33.9588 1.72505 34.5051Z" stroke="currentColor" stroke-width="3"/>
                </svg>
                Favoritos
              </a>
              
              <a href="{% url 'backstage:amigos' %}" class="user-dropdown-item" role="menuitem" tabindex="0">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2"/>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Amigos
              </a>
              
              <div class="user-dropdown-divider"></div>
              
              <a href="{% url 'backstage:index' %}" class="user-dropdown-item" role="menuitem" tabindex="0">
                <img src="{% static 'images/configurações.png' %}" alt="Configurações" width="18" height="18" style="filter: brightness(0) invert(1); opacity: 0.7;">
                Configurações
              </a>
              
              <a href="{% url 'backstage:index' %}" class="user-dropdown-item" role="menuitem" tabindex="0">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                  <path d="M12 16v-4m0-4h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Ajuda
              </a>
              
              <div class="user-dropdown-divider"></div>
              
              <a href="{% url 'backstage:sair' %}" class="user-dropdown-item logout-item" role="menuitem" tabindex="0">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                  <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  <path d="M16 17l5-5-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M21 12H9" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                Sair
              </a>
            </div>
          </div>
          {% else %}
          <a href="{% url 'backstage:login' %}" class="btn-login">Login</a>
          {% endif %}
        </div>
      </nav>
    </div>
  </header>

  <div class="friends-container">
    <div class="container">
      <div class="page-header">
        <h1>Amigos</h1>
        <p class="page-description">Conecte-se com outros cinéfilos e compartilhe suas paixões</p>
      </div>

      <!-- Tabs de Navegação -->
      <div class="friends-tabs">
        <button class="friends-tab active" data-tab="meus-amigos">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2"/>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Meus Amigos
          <span class="badge">{{ amigos_count }}</span>
        </button>
        
        <button class="friends-tab" data-tab="solicitacoes">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
            <path d="M7 11V7a5 5 0 0 1 10 0v4" stroke="currentColor" stroke-width="2"/>
          </svg>
          Solicitações
          {% if solicitacoes_pendentes_count > 0 %}
          <span class="badge badge-alert">{{ solicitacoes_pendentes_count }}</span>
          {% endif %}
        </button>
        
        <button class="friends-tab" data-tab="buscar">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
            <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
            <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          Buscar Amigos
        </button>
      </div>

      <!-- Conteúdo das Tabs -->
      <div class="friends-content">
        <!-- Tab: Meus Amigos -->
        <div class="friends-tab-content active" id="meus-amigos">
          {% if amigos %}
          <div class="friends-grid">
            {% for amigo in amigos %}
            <div class="friend-card">
              <div class="friend-avatar">
                <img src="https://ui-avatars.com/api/?name={{ amigo.username }}&background=00d9ff&color=0a0e27&size=100" alt="{{ amigo.username }}">
              </div>
              <div class="friend-info">
                <h3 class="friend-name">{{ amigo.username }}</h3>
                <p class="friend-stats">{{ amigo.criticas_count|default:0 }} reviews</p>
              </div>
              <div class="friend-actions">
                <button class="btn-friend-action btn-message" data-user-id="{{ amigo.id }}">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" stroke="currentColor" stroke-width="2"/>
                  </svg>
                  Mensagem
                </button>
                <button class="btn-friend-action btn-remove" data-user-id="{{ amigo.id }}" onclick="removerAmigo({{ amigo.id }}, '{{ amigo.username }}')">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2"/>
                    <circle cx="8.5" cy="7" r="4" stroke="currentColor" stroke-width="2"/>
                    <line x1="18" y1="8" x2="23" y2="13" stroke="currentColor" stroke-width="2"/>
                    <line x1="23" y1="8" x2="18" y2="13" stroke="currentColor" stroke-width="2"/>
                  </svg>
                  Remover
                </button>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div class="empty-state">
            <svg width="80" height="80" viewBox="0 0 24 24" fill="none">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2"/>
              <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2"/>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87" stroke="currentColor" stroke-width="2"/>
              <path d="M16 3.13a4 4 0 0 1 0 7.75" stroke="currentColor" stroke-width="2"/>
            </svg>
            <h3>Você ainda não tem amigos</h3>
            <p>Comece a buscar outros usuários para adicionar!</p>
            <button class="btn-primary" onclick="document.querySelector('[data-tab=buscar]').click()">Buscar Amigos</button>
          </div>
          {% endif %}
        </div>

        <!-- Tab: Solicitações -->
        <div class="friends-tab-content" id="solicitacoes">
          {% if solicitacoes_recebidas %}
          <h2 class="section-title">Solicitações Recebidas</h2>
          <div class="friends-grid">
            {% for solicitacao in solicitacoes_recebidas %}
            <div class="friend-card friend-request">
              <div class="friend-avatar">
                <img src="https://ui-avatars.com/api/?name={{ solicitacao.remetente.username }}&background=00d9ff&color=0a0e27&size=100" alt="{{ solicitacao.remetente.username }}">
              </div>
              <div class="friend-info">
                <h3 class="friend-name">{{ solicitacao.remetente.username }}</h3>
                <p class="friend-date">{{ solicitacao.data_criacao|timesince }} atrás</p>
              </div>
              <div class="friend-actions">
                <button class="btn-friend-action btn-accept" onclick="aceitarSolicitacao({{ solicitacao.id }})">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <polyline points="20 6 9 17 4 12" stroke="currentColor" stroke-width="2"/>
                  </svg>
                  Aceitar
                </button>
                <button class="btn-friend-action btn-reject" onclick="rejeitarSolicitacao({{ solicitacao.id }})">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2"/>
                    <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2"/>
                  </svg>
                  Rejeitar
                </button>
              </div>
            </div>
            {% endfor %}
          </div>
          {% endif %}

          {% if solicitacoes_enviadas %}
          <h2 class="section-title">Solicitações Enviadas</h2>
          <div class="friends-grid">
            {% for solicitacao in solicitacoes_enviadas %}
            <div class="friend-card friend-request-sent">
              <div class="friend-avatar">
                <img src="https://ui-avatars.com/api/?name={{ solicitacao.destinatario.username }}&background=00d9ff&color=0a0e27&size=100" alt="{{ solicitacao.destinatario.username }}">
              </div>
              <div class="friend-info">
                <h3 class="friend-name">{{ solicitacao.destinatario.username }}</h3>
                <p class="friend-date">Enviada {{ solicitacao.data_criacao|timesince }} atrás</p>
                <span class="status-badge status-pending">Pendente</span>
              </div>
              <div class="friend-actions">
                <button class="btn-friend-action btn-cancel" onclick="cancelarSolicitacao({{ solicitacao.id }})">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <line x1="18" y1="6" x2="6" y2="18" stroke="currentColor" stroke-width="2"/>
                    <line x1="6" y1="6" x2="18" y2="18" stroke="currentColor" stroke-width="2"/>
                  </svg>
                  Cancelar
                </button>
              </div>
            </div>
            {% endfor %}
          </div>
          {% endif %}

          {% if not solicitacoes_recebidas and not solicitacoes_enviadas %}
          <div class="empty-state">
            <svg width="80" height="80" viewBox="0 0 24 24" fill="none">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
              <path d="M7 11V7a5 5 0 0 1 10 0v4" stroke="currentColor" stroke-width="2"/>
            </svg>
            <h3>Nenhuma solicitação</h3>
            <p>Você não tem solicitações de amizade pendentes</p>
          </div>
          {% endif %}
        </div>

        <!-- Tab: Buscar Amigos -->
        <div class="friends-tab-content" id="buscar">
          <div class="search-friends-box">
            <input type="text" id="searchFriendsInput" class="search-friends-input" placeholder="Buscar usuários por nome...">
            <button class="btn-search" onclick="buscarUsuarios()">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
                <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              Buscar
            </button>
          </div>

          <div id="searchResults" class="friends-grid" style="margin-top: 2rem;">
            <!-- Resultados da busca serão inseridos aqui via JavaScript -->
          </div>

          <div id="searchEmptyState" class="empty-state" style="display: none;">
            <svg width="80" height="80" viewBox="0 0 24 24" fill="none">
              <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
              <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <h3>Nenhum usuário encontrado</h3>
            <p>Tente buscar por outro nome</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% include 'backstage/_mobile_search.html' %}
  {% include 'backstage/_mobile_bottom_nav.html' %}
  {% include 'backstage/_mobile_scripts.html' %}

  <script src="{% static 'js/profile_menu.js' %}"></script>
  <script src="{% static 'js/search-suggestions.js' %}"></script>
  <script src="{% static 'js/friends.js' %}"></script>
</body>
</html>
