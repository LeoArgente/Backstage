{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Comunidade - Backstage</title>
  <link rel="icon" type="image/png" href="{% static 'images/Icone_Backstage.png' %}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/main.css' %}?v=1.0">
  <link rel="stylesheet" href="{% static 'css/community.css' %}?v=1.2">
  <link rel="stylesheet" href="{% static 'css/movies.css' %}?v=1.0">
  <link rel="stylesheet" href="{% static 'css/dropdown.css' %}?v=1.0">
  <link rel="stylesheet" href="{% static 'css/mobile.css' %}?v=1.0">
</head>
<body>
  {% csrf_token %}
  {% include 'backstage/_mobile_header.html' %}
  <header class="site-header">
    <div class="container">
      <nav class="nav-primary">
                <a class="brand" href="{% url 'backstage:index' %}">
            <img src="{% static 'images/Logo_Backstage_branca.png' %}"
                 alt="Backstage Logo"
                 width="250">
                </a>

        <div class="nav-menu">
          <a href="{% url 'backstage:index' %}" class="nav-link">Início</a>
          <a href="{% url 'backstage:movies' %}" class="nav-link">Filmes</a>
          <a href="{% url 'backstage:series' %}" class="nav-link">Séries</a>
          <a href="{% url 'backstage:lists' %}" class="nav-link">Listas</a>
          <a href="{% url 'backstage:comunidade' %}" class="nav-link active">Comunidade</a>
        </div>

        <div class="nav-actions">
          <form method="get" action="{% url 'backstage:buscar' %}" class="search-container">
            <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none">
              <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
              <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <input type="search" name="q" class="search-input" placeholder="Buscar filmes, séries..." autocomplete="off" />
            <input type="hidden" name="tipo" value="titulo" />
            <div class="search-suggestions"></div>
          </form>

          {% include 'backstage/_notifications.html' %}

          {% include 'backstage/_user_dropdown.html' %}
        </div>
      </nav>
    </div>
  </header>

  <div class="page-header">
    <div class="container">
      <div class="page-header-content">
        <h1 class="page-title">Comunidade</h1>
        <p class="page-description">Conecte-se com outros amantes do cinema e compartilhe suas paixões cinematográficas</p>

        <button class="btn btn-primary create-community-btn" id="create-community-btn">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v14M5 12h14"/>
          </svg>
          Criar Comunidade
        </button>
      </div>
    </div>
  </div>

  <main class="container">
    <!-- Minhas Comunidades Section -->
    {% if user.is_authenticated and minhas_comunidades %}
    <section class="communities-section">
      <div class="section-header">
        <h2 class="section-title">Minhas Comunidades</h2>
      </div>

      <div class="communities-grid">
        {% for membro in minhas_comunidades %}
        <div class="community-card">
          {% if membro.role == 'admin' %}
          <div class="community-card-menu">
            <button class="community-menu-btn" data-community-id="{{ membro.comunidade.id }}">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                <circle cx="12" cy="5" r="2"/>
                <circle cx="12" cy="12" r="2"/>
                <circle cx="12" cy="19" r="2"/>
              </svg>
            </button>
            <div class="community-dropdown-menu" id="menu-{{ membro.comunidade.id }}">
              <a href="#" class="dropdown-item edit-community" data-community-id="{{ membro.comunidade.id }}">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                  <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
                Editar
              </a>
              <a href="#" class="dropdown-item delete-community" data-community-id="{{ membro.comunidade.id }}" data-community-name="{{ membro.comunidade.nome }}">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="3 6 5 6 21 6"/>
                  <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                </svg>
                Excluir
              </a>
            </div>
          </div>
          {% endif %}
          {% if membro.comunidade.foto_perfil %}
            <img src="{{ membro.comunidade.foto_perfil.url }}" alt="{{ membro.comunidade.nome }}" class="community-icon-img">
          {% else %}
            <img src="https://i.pinimg.com/1200x/bd/e3/e0/bde3e0aaf3dd35b4a42eed8ba9980591.jpg" alt="{{ membro.comunidade.nome }}" class="community-icon-img">
          {% endif %}
          <div class="community-content">
            <h3 class="community-name">{{ membro.comunidade.nome }}</h3>
            <p class="community-description">{{ membro.comunidade.descricao|truncatewords:20 }}</p>
            <div class="community-stats">
              <span class="stat">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                  <circle cx="9" cy="7" r="4"/>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                {{ membro.comunidade.membros.count }} membros
              </span>
              <span class="stat">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                0 posts
              </span>
            </div>
            <div class="community-tags">
              <span class="tag">{{ membro.get_role_display }}</span>
            </div>
          </div>
          <a href="{% url 'backstage:detalhes_comunidade' membro.comunidade.slug %}" class="btn-join joined">Ver Comunidade</a>
        </div>
        {% endfor %}
      </div>
    </section>
    {% endif %}

    <!-- Communities Section -->
    <section class="communities-section">
      <div class="section-header">
        <h2 class="section-title">{% if user.is_authenticated and minhas_comunidades %}Outras Comunidades{% else %}Comunidades Populares{% endif %}</h2>
      </div>

      <div class="communities-grid">
        {% for comunidade in comunidades_publicas %}
        <div class="community-card">
          {% if comunidade.foto_perfil %}
            <img src="{{ comunidade.foto_perfil.url }}" alt="{{ comunidade.nome }}" class="community-icon-img">
          {% else %}
            <img src="https://i.pinimg.com/1200x/bd/e3/e0/bde3e0aaf3dd35b4a42eed8ba9980591.jpg" alt="{{ comunidade.nome }}" class="community-icon-img">
          {% endif %}
          <div class="community-content">
            <h3 class="community-name">{{ comunidade.nome }}</h3>
            <p class="community-description">{{ comunidade.descricao|truncatewords:20 }}</p>
            <div class="community-stats">
              <span class="stat">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                  <circle cx="9" cy="7" r="4"/>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                {{ comunidade.membros.count }} membros
              </span>
              <span class="stat">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
                </svg>
                0 posts
              </span>
            </div>
            <div class="community-tags">
              <span class="tag">Público</span>
            </div>
          </div>
          <button class="btn-join" data-slug="{{ comunidade.slug }}">Entrar</button>
        </div>
        {% empty %}
        <p style="color: #888; text-align: center; width: 100%; padding: 2rem;">Nenhuma comunidade pública disponível no momento.</p>
        {% endfor %}

      </div>
    </section>
        <!-- Posts Feed -->
        <div class="posts-feed" id="posts-feed">
          <!-- Posts will be populated by JavaScript -->
        </div>

        <div class="load-more-section">
          <button class="btn btn-secondary btn-large load-more-btn" id="load-more">
            Carregar mais comunidades
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 5v14M5 12h14"/>
            </svg>
          </button>
        </div>
      </div>

    </div>
  </main>

  <!-- Create Post Modal -->
  <div class="modal-overlay" id="create-post-modal">
    <div class="modal large-modal">
      <div class="modal-header">
        <h2>Criar Post</h2>
        <button class="modal-close" id="modal-close">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>
      
      <form class="modal-form" id="create-post-form">
        <div class="form-group">
          <label for="post-type">Tipo de Post</label>
          <select id="post-type" name="type" required>
            <option value="discussion">Discussão</option>
            <option value="review">Avaliação</option>
            <option value="recommendation">Recomendação</option>
            <option value="list">Lista</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="post-content">Conteúdo</label>
          <textarea id="post-content" name="content" placeholder="Compartilhe seus pensamentos..." rows="6" required></textarea>
        </div>
        
        <div class="form-group movie-selector" id="movie-selector" style="display: none;">
          <label for="selected-movie">Filme/Série</label>
          <input type="text" id="selected-movie" placeholder="Buscar filme ou série..." />
          <div class="movie-suggestions" id="movie-suggestions"></div>
        </div>
        
        <div class="form-group rating-selector" id="rating-selector" style="display: none;">
          <label>Avaliação</label>
          <div class="star-rating" id="star-rating">
            <button type="button" class="star" data-rating="1">★</button>
            <button type="button" class="star" data-rating="2">★</button>
            <button type="button" class="star" data-rating="3">★</button>
            <button type="button" class="star" data-rating="4">★</button>
            <button type="button" class="star" data-rating="5">★</button>
          </div>
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn btn-secondary" id="cancel-post">Cancelar</button>
          <button type="submit" class="btn btn-primary">Publicar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Create Community Modal -->
  <div class="modal-overlay" id="create-community-modal">
    <div class="modal">
      <div class="modal-header">
        <h2>Nova Comunidade</h2>
        <button class="modal-close" id="community-modal-close">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>

      <form class="modal-form" id="create-community-form" enctype="multipart/form-data">
        <div class="form-group">
          <label for="community-photo">Foto de Perfil</label>
          <div class="photo-upload-container">
            <div class="photo-preview" id="photo-preview">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2"/>
                <circle cx="8.5" cy="8.5" r="1.5"/>
                <path d="M21 15l-5-5L5 21"/>
              </svg>
              <p>Escolher imagem</p>
            </div>
            <input type="file" id="community-photo" name="foto_perfil" accept="image/*" style="display: none;">
          </div>
        </div>

        <div class="form-group">
          <label for="community-name">Nome</label>
          <input type="text" id="community-name" name="name" placeholder="Ex: Amantes de Ficção Científica" required>
        </div>

        <div class="form-group">
          <label for="community-description">Descrição</label>
          <textarea id="community-description" name="description" placeholder="Descreva o propósito da sua comunidade..." rows="3" required></textarea>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" id="cancel-community">Cancelar</button>
          <button type="submit" class="btn btn-primary">Criar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Community Modal -->
  <div class="modal-overlay" id="edit-community-modal">
    <div class="modal">
      <div class="modal-header">
        <h2>Editar Comunidade</h2>
        <button class="modal-close" id="edit-modal-close">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>

      <form class="modal-form" id="edit-community-form" enctype="multipart/form-data">
        <input type="hidden" id="edit-community-id" name="community_id">

        <div class="form-group">
          <label for="edit-community-photo">Foto de Perfil</label>
          <div class="photo-upload-container">
            <div class="photo-preview" id="edit-photo-preview">
              <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2"/>
                <circle cx="8.5" cy="8.5" r="1.5"/>
                <path d="M21 15l-5-5L5 21"/>
              </svg>
              <p>Escolher imagem</p>
            </div>
            <input type="file" id="edit-community-photo" name="foto_perfil" accept="image/*" style="display: none;">
          </div>
        </div>

        <div class="form-group">
          <label for="edit-community-name">Nome</label>
          <input type="text" id="edit-community-name" name="name" placeholder="Ex: Amantes de Ficção Científica" required>
        </div>

        <div class="form-group">
          <label for="edit-community-description">Descrição</label>
          <textarea id="edit-community-description" name="description" placeholder="Descreva o propósito da sua comunidade..." rows="3" required></textarea>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" id="cancel-edit-community">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar Alterações</button>
        </div>
      </form>
    </div>
  </div>

  {% include 'backstage/_mobile_search.html' %}
  {% include 'backstage/_mobile_bottom_nav.html' %}
  {% include 'backstage/_mobile_scripts.html' %}

  <style>
    .photo-upload-container {
      margin-bottom: 0;
    }

    .photo-preview {
      width: 100%;
      min-height: 110px;
      max-height: 300px;
      height: auto;
      border: 2px dashed rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(255, 255, 255, 0.02);
      position: relative;
      overflow: visible;
    }

    .photo-preview.has-image {
      min-height: unset;
      padding: 0;
      border: none;
      background: transparent;
      display: block;
    }

    .photo-preview:hover {
      border-color: #dc2626;
      background: rgba(220, 38, 38, 0.05);
    }

    .photo-preview svg {
      color: rgba(255, 255, 255, 0.4);
      margin-bottom: 4px;
      width: 36px;
      height: 36px;
    }

    .photo-preview p {
      color: rgba(255, 255, 255, 0.6);
      font-size: 13px;
      margin: 0;
    }

    .photo-preview img {
      width: 100%;
      height: auto;
      max-height: 300px;
      object-fit: contain;
      position: relative;
      display: block;
      border-radius: 10px;
      border: 2px solid #dc2626;
    }

    .photo-preview.has-image svg,
    .photo-preview.has-image p {
      display: none;
    }
  </style>

  <script>
    // Preview de foto da comunidade
    document.addEventListener('DOMContentLoaded', function() {
      const photoInput = document.getElementById('community-photo');
      const photoPreview = document.getElementById('photo-preview');

      if (photoPreview && photoInput) {
        photoPreview.addEventListener('click', () => {
          photoInput.click();
        });

        photoInput.addEventListener('change', function(e) {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
              // Adicionar imagem ao preview
              const img = document.createElement('img');
              img.src = event.target.result;
              photoPreview.innerHTML = '';
              photoPreview.appendChild(img);
              photoPreview.classList.add('has-image');
            };
            reader.readAsDataURL(file);
          }
        });
      }
    });
  </script>

  <script src="{% static 'js/main.js' %}" defer></script>
  <script src="{% static 'js/community.js' %}?v=1.1" defer></script>
  <script src="{% static 'js/filter-popup.js' %}" defer></script>
  <script src="{% static 'js/search-suggestions.js' %}" defer></script>
  <script src="{% static 'js/profile_menu.js' %}"></script>
  <script src="{% static 'js/notifications.js' %}" defer></script>

  {% include 'backstage/footer_default.html' %}
</body>
</html>