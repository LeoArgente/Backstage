{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ comunidade.nome }} - Backstage</title>
  <link rel="icon" type="image/png" href="{% static 'images/Icone_Backstage.png' %}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/main.css' %}?v=1.0">
  <link rel="stylesheet" href="{% static 'css/community.css' %}?v=1.2">
  <link rel="stylesheet" href="{% static 'css/dropdown.css' %}?v=1.0">
  <link rel="stylesheet" href="{% static 'css/mobile.css' %}?v=1.0">
  <link rel="stylesheet" href="{% static 'css/community-details.css' %}?v=1.0">

</head>
<body class="community-page">
  {% csrf_token %}
  {% include 'backstage/_mobile_header.html' %}
  
  <header class="site-header">
    <div class="container">
      <nav class="nav-primary">
        <a class="brand" href="{% url 'backstage:index' %}">
          <img src="{% static 'images/Logo_Backstage_branca.png' %}"
               alt="Backstage Logo"
               width="250">
        </a>

        <div class="nav-menu">
          <a href="{% url 'backstage:index' %}" class="nav-link">Início</a>
          <a href="{% url 'backstage:movies' %}" class="nav-link">Filmes</a>
          <a href="{% url 'backstage:series' %}" class="nav-link">Séries</a>
          <a href="{% url 'backstage:lists' %}" class="nav-link">Listas</a>
          <a href="{% url 'backstage:comunidade' %}" class="nav-link active">Comunidade</a>
        </div>

        <div class="nav-actions">
          <form method="get" action="{% url 'backstage:buscar' %}" class="search-container">
            <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none">
              <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
              <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <input type="search" name="q" class="search-input" placeholder="Buscar filmes, séries..." autocomplete="off" />
            <input type="hidden" name="tipo" value="titulo" />
          </form>

          {% include 'backstage/_notifications.html' %}
          {% include 'backstage/_user_dropdown.html' %}
        </div>
      </nav>
    </div>
  </header>

  <main class="community-details">
    <div class="community-content">
      <!-- Communities Sidebar (Left) -->
      <div class="communities-sidebar">
        <div class="communities-sidebar-header">
          <h3>Minhas Comunidades</h3>
        </div>
        <div class="communities-list">
          {% for comm in minhas_comunidades %}
            <a href="{% url 'backstage:detalhes_comunidade' comm.slug %}"
               class="community-item {% if comm.id == comunidade.id %}active{% endif %}">
              {% if comm.foto_perfil %}
                <img src="{{ comm.foto_perfil.url }}" alt="{{ comm.nome }}" class="community-item-icon">
              {% else %}
                <div class="community-item-placeholder">
                  {{ comm.nome|first|upper }}
                </div>
              {% endif %}
              <div class="community-item-info">
                <div class="community-item-name">{{ comm.nome }}</div>
                <div class="community-item-members">{{ comm.membros.count }} membro{{ comm.membros.count|pluralize }}</div>
              </div>
            </a>
          {% empty %}
            <p style="color: var(--text-muted); text-align: center; padding: 2rem; font-size: 0.875rem;">
              Você ainda não participa de nenhuma comunidade
            </p>
          {% endfor %}
        </div>
      </div>

      <!-- Chat Container -->
      <div class="chat-container">
        {% if meu_papel %}
          {% include 'backstage/community_chat.html' with comunidade=comunidade is_admin=is_admin %}
        {% else %}
          <div class="community-chat">
            <div class="chat-header">
              <h3>Chat da Comunidade</h3>
            </div>
            <div class="chat-messages">
              <div class="chat-empty">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                </svg>
                <h4>Acesso restrito</h4>
                <p>Você precisa ser membro<br>para ver e enviar mensagens</p>
              </div>
            </div>
          </div>
        {% endif %}
      </div>

      <!-- Community Sidebar -->
      <div class="community-sidebar">
        <!-- Community Info -->
        <div class="community-info">
          <div class="community-info-header">
            {% if comunidade.foto_perfil %}
              <img src="{{ comunidade.foto_perfil.url }}" alt="{{ comunidade.nome }}" class="community-photo">
            {% else %}
              <div class="community-photo">
                {{ comunidade.nome|first|upper }}
              </div>
            {% endif %}
            <div>
              <h2 class="community-name">{{ comunidade.nome }}</h2>
            </div>
          </div>
          {% if comunidade.descricao %}
            <p class="community-description">{{ comunidade.descricao }}</p>
          {% endif %}
        </div>

        <!-- Members List -->
        <div class="community-members">
          <div class="members-header">
            Membros ({{ comunidade.membros.count }})
          </div>
          <div class="members-list">
            {% for membro_comunidade in membros %}
              <div class="member-item-container">
                <a href="{% url 'backstage:perfil_usuario' membro_comunidade.usuario.username %}" class="member-item">
                  {% if membro_comunidade.usuario.foto_perfil %}
                    <img src="{{ membro_comunidade.usuario.foto_perfil.url }}" alt="{{ membro_comunidade.usuario.username }}" class="member-avatar">
                  {% else %}
                    <div class="member-avatar-placeholder">
                      {{ membro_comunidade.usuario.username|first|upper }}
                    </div>
                  {% endif %}
                  <div class="member-info">
                    <div class="member-name">{{ membro_comunidade.usuario.username }}</div>
                    {% if membro_comunidade.usuario == comunidade.criador %}
                      <div class="member-role">Criador</div>
                    {% endif %}
                  </div>
                  {% if membro_comunidade.role == 'admin' %}
                    <span class="member-badge admin">Admin</span>
                  {% elif membro_comunidade.role == 'mod' %}
                    <span class="member-badge mod">Mod</span>
                  {% endif %}
                </a>

                <!-- Dropdown Menu Button -->
                {% if membro_comunidade.usuario != user %}
                  <button class="member-menu-btn" data-member-id="{{ membro_comunidade.usuario.id }}" data-member-username="{{ membro_comunidade.usuario.username }}">
                    <svg width="18" height="18" fill="currentColor" viewBox="0 0 24 24">
                      <circle cx="12" cy="5" r="2"/>
                      <circle cx="12" cy="12" r="2"/>
                      <circle cx="12" cy="19" r="2"/>
                    </svg>
                  </button>

                  <!-- Dropdown Menu -->
                  <div class="member-dropdown-menu" id="member-menu-{{ membro_comunidade.usuario.id }}">
                    <a href="{% url 'backstage:perfil_usuario' membro_comunidade.usuario.username %}" class="member-dropdown-item">
                      <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                      </svg>
                      Ver Perfil
                    </a>
                    {% if is_admin and membro_comunidade.usuario != comunidade.criador %}
                      {% if membro_comunidade.role != 'admin' %}
                        <button class="member-dropdown-item promote-admin-btn" data-member-id="{{ membro_comunidade.usuario.id }}" data-member-username="{{ membro_comunidade.usuario.username }}">
                          <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                          </svg>
                          Promover a Admin
                        </button>
                      {% endif %}
                      <button class="member-dropdown-item danger kick-member-btn" data-member-id="{{ membro_comunidade.usuario.id }}" data-member-username="{{ membro_comunidade.usuario.username }}">
                        <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7a4 4 0 11-8 0 4 4 0 018 0zM9 14a6 6 0 00-6 6v1h12v-1a6 6 0 00-6-6zM21 12h-6"/>
                        </svg>
                        Expulsar
                      </button>
                    {% endif %}
                  </div>
                {% endif %}
              </div>
            {% empty %}
              <p style="color: var(--text-muted); text-align: center; padding: 2rem;">Nenhum membro ainda</p>
            {% endfor %}
          </div>
        </div>

        <!-- Leave Community Button -->
        {% if meu_papel %}
          <button class="leave-community-button">
            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
            </svg>
            Sair
          </button>
        {% endif %}
      </div>
    </div>
  </main>

  <!-- Movie Recommendation Modal -->
  <div class="movie-modal" id="movieModal">
    <div class="movie-modal-content">
      <div class="movie-modal-header">
        <h3>Recomendar Filme</h3>
        <button type="button" class="movie-modal-close" id="closeModal">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
          </svg>
        </button>
      </div>
      <div class="movie-modal-body">
        <input 
          type="text" 
          class="movie-search-input" 
          id="movieSearchInput" 
          placeholder="Buscar filme..."
          autocomplete="off"
        />
        <div class="movie-search-results" id="movieResults"></div>
      </div>
    </div>
  </div>


  <script src="{% static 'js/profile_menu.js' %}"></script>
  <script src="{% static 'js/community.js' %}?v=1.0"></script>

  {% include 'backstage/footer_default.html' %}
  {% include 'backstage/_mobile_bottom_nav.html' %}
</body>
</html>
