{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Backstage</title>
  <link rel="icon" type="image/png" href="{% static 'images/Icone_Backstage.png' %}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/main.css' %}">
  <link rel="stylesheet" href="{% static 'css/movies.css' %}">
  <link rel="stylesheet" href="{% static 'css/movie_details.css' %}">
  <link rel="stylesheet" href="{% static 'css/dropdown.css' %}">
  <link rel="stylesheet" href="{% static 'css/mobile.css' %}">
  <link rel="stylesheet" href="{% static 'css/intro.css' %}">
  {% block extra_css %}{% endblock %}
</head>
<body>
  <!-- Video Intro Overlay -->
  <div class="intro-overlay">
    <div class="intro-video-container">
      <video class="intro-video" muted playsinline preload="auto">
        <source src="{% static 'videos/intro.mp4' %}" type="video/mp4">
        Seu navegador não suporta vídeo HTML5.
      </video>
      <button class="intro-skip-btn" aria-label="Pular introdução">
        Pular
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="13 17 18 12 13 7"></polyline>
          <polyline points="6 17 11 12 6 7"></polyline>
        </svg>
      </button>
    </div>
  </div>

  {% include 'backstage/_mobile_header.html' %}
    <header class="site-header">
    <div class="container">
      <nav class="nav-primary">
        <a class="brand" href="{% url 'backstage:index' %}">
            <img src="{% static 'images/Logo_Backstage_branca.png' %}"
                 alt="Backstage Logo"
                 width="250">
        </a>

        <div class="nav-menu">
          <a href="{% url 'backstage:index' %}" class="nav-link active">Início</a>
          <a href="{% url 'backstage:movies' %}" class="nav-link">Filmes</a>
          <a href="{% url 'backstage:series' %}" class="nav-link">Séries</a>
          <a href="{% url 'backstage:lists' %}" class="nav-link">Listas</a>
          <a href="{% url 'backstage:comunidade' %}" class="nav-link">Comunidade</a>
        </div>

        <div class="nav-actions">
          <form method="get" action="{% url 'backstage:buscar' %}" class="search-container">
            <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none">
              <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
              <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <input type="search" name="q" class="search-input" placeholder="Buscar filmes, séries..." autocomplete="off" />
            <input type="hidden" name="tipo" value="titulo" />
            <div class="search-suggestions"></div>
          </form>

          {% include 'backstage/_notifications.html' %}

          {% include 'backstage/_user_dropdown.html' %}
        </div>
      </nav>
    </div>
  </header>

<!-- Hero Section -->
  <section class="hero">
    <!-- Desktop backdrop with dual layers for smooth crossfade -->
    <div class="hero-backdrop-desktop">
      <img class="hero-backdrop-img hero-backdrop-img-1" src="" alt="" />
      <img class="hero-backdrop-img hero-backdrop-img-2" src="" alt="" style="opacity: 0;" />
      <div class="hero-gradient"></div>
    </div>

    <!-- Mobile backdrop with dual layers for smooth crossfade -->
    <div class="hero-backdrop-mobile">
      <img class="hero-backdrop-img hero-backdrop-img-1" src="" alt="" />
      <img class="hero-backdrop-img hero-backdrop-img-2" src="" alt="" style="opacity: 0;" />
      <div class="hero-gradient"></div>
    </div>

    <!-- Hero content -->
    <div class="container hero-content">
      <div class="hero-info">
        <span class="hero-badge">Carregando...</span>
        <h1 class="hero-title">Carregando os filmes em alta...</h1>
        <div class="hero-meta">
          <span class="hero-year">2024</span>
          <span class="hero-duration">120 min</span>
          <span class="hero-rating">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
            </svg>
            4.5
          </span>
        </div>
        <div class="hero-actions">
          <button class="btn btn-primary btn-large">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
              <path d="M8 5v14l11-7z"/>
            </svg>
            Assistir Trailer
          </button>
          <button class="btn btn-secondary btn-large">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 5v14M5 12h14"/>
            </svg>
            Adicionar à Lista
          </button>
        </div>
      </div>
    </div>

    <!-- Navigation indicators (will be populated by JS) -->
    <div class="hero-indicators"></div>
  </section>

  <main class="container">

    <!-- GOATS (Greatest of All Time) -->
    <section class="section">
      <div class="section-header">
        <h2 class="section-title">
          <svg class="title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
          </svg>
          GOATS
        </h2>
      </div>
      <div class="carousel">
        <button class="carousel-btn prev">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 18l-6-6 6-6"/>
          </svg>
        </button>
        <div class="carousel-track" id="goats-movies">
          <!-- Filmes GOATS serão inseridos via JS -->
        </div>
        <button class="carousel-btn next">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 18l6-6-6-6"/>
          </svg>
        </button>
      </div>
    </section>


    <!-- Em Cartaz -->
    <section class="section">
      <div class="section-header">
        <h2 class="section-title">
          <svg class="title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M7 4V2a1 1 0 0 0-1-1H4a1 1 0 0 0-1 1v2H2a1 1 0 0 0-1 1v14a1 1 0 0 0 1 1h20a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-1V2a1 1 0 0 0-1-1h-2a1 1 0 0 0-1 1v2H7z"/>
            <path d="M5 9h14M5 13h14M5 17h14"/>
          </svg>
          Em Cartaz
        </h2>
      </div>
      <div class="carousel">
        <button class="carousel-btn prev">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 18l-6-6 6-6"/>
          </svg>
        </button>
        <div class="carousel-track" id="em-cartaz-movies">
          <!-- Filmes em cartaz serão inseridos via JS -->
        </div>
        <button class="carousel-btn next">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 18l6-6-6-6"/>
          </svg>
        </button>
      </div>
    </section>

    <!-- Clássicos Imperdíveis -->
    <section class="section">
      <div class="section-header">
        <h2 class="section-title">
          <svg class="title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M7 2h3l2 3h7a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2z"/>
            <circle cx="12" cy="13" r="3"/>
          </svg>
          Clássicos Imperdíveis
        </h2>
      </div>
      <div class="carousel">
        <button class="carousel-btn prev">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 18l-6-6 6-6"/>
          </svg>
        </button>
        <div class="carousel-track" id="classicos-movies">
          <!-- Filmes clássicos serão inseridos via JS -->
        </div>
        <button class="carousel-btn next">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 18l6-6-6-6"/>
          </svg>
        </button>
      </div>
    </section>

    <!-- Recomendados para você -->
    <section class="section">
      <div class="section-header">
        <h2 class="section-title">
          <svg class="title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/>
          </svg>
          Recomendados para você
        </h2>
        <button class="refresh-btn">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.64A9 9 0 0 0 20.49 15"/>
          </svg>
          Atualizar
        </button>
      </div>
      <div class="carousel">
        <button class="carousel-btn prev">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 18l-6-6 6-6"/>
          </svg>
        </button>
        <div class="carousel-track" id="recommended-movies">
          <!-- Filmes serão inseridos via JS -->
        </div>
        <button class="carousel-btn next">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 18l6-6-6-6"/>
          </svg>
        </button>
      </div>
    </section>

    <!-- Activity Feed -->
    <section class="section">
      <div class="section-header">
        <h2 class="section-title">
          <svg class="title-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
          Atividade dos amigos
        </h2>
      </div>
      <div class="activity-feed">
        {% if user.is_authenticated %}
          {% if atividades_amigos %}
            {% for atividade in atividades_amigos %}
            <div class="activity-item">
              <img src="https://ui-avatars.com/api/?name={{ atividade.usuario.username }}&background=random&size=48" class="activity-avatar" alt="{{ atividade.usuario.username }}">
              <div class="activity-content">
                <p>
                  <strong>{{ atividade.usuario.username }}</strong> avaliou 
                  {% if atividade.tipo == 'filme' %}
                    <a href="{% url 'backstage:detalhes_filme' atividade.tmdb_id %}">{{ atividade.titulo }}</a>
                  {% else %}
                    <a href="{% url 'backstage:detalhes_serie' atividade.tmdb_id %}">{{ atividade.titulo }}</a>
                  {% endif %}
                  com
                  <span class="rating-stars">{% for i in "12345" %}{% if forloop.counter <= atividade.nota %}★{% else %}☆{% endif %}{% endfor %}</span>
                </p>
                <span class="activity-time">{{ atividade.data|timesince }} atrás</span>
              </div>
            </div>
            {% endfor %}
          {% else %}
            <div class="activity-empty">
              <p>Nenhuma atividade dos seus amigos ainda.</p>
              <a href="{% url 'backstage:amigos' %}#buscar" class="btn-primary">Adicionar Amigos</a>
            </div>
          {% endif %}
        {% else %}
          <div class="activity-empty">
            <p>Faça login para ver as atividades dos seus amigos!</p>
            <a href="{% url 'backstage:login' %}" class="btn-primary">Fazer Login</a>
          </div>
        {% endif %}
      </div>
    </section>
  </main>

  <!-- Footer aprimorado -->
  <footer class="site-footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <div class="brand">
            <img src="{% static 'images/Logo_Backstage_branca.png' %}"
                 alt="Backstage Logo"
                 width="40" height="40">
          </div>
          <p class="footer-description">
            Sua jornada cinematográfica começa aqui. Entre no Backstage e registre cada frame.
          </p>
        </div>
        
        <div class="footer-section">
          <h3 class="footer-title">Explorar</h3>
          <ul class="footer-links">
            <li><a href="{% url 'backstage:index' %}">Início</a></li>
            <li><a href="{% url 'backstage:movies' %}">Filmes</a></li>
            <li><a href="{% url 'backstage:series' %}">Séries</a></li>
            <li><a href="{% url 'backstage:lists' %}">Listas</a></li>
            <li><a href="{% url 'backstage:comunidade' %}">Comunidade</a></li>
          </ul>
        </div>
        
        <div class="footer-section">
          <h3 class="footer-title">Suporte</h3>
          <ul class="footer-links">
            <li><a href="#">Ajuda</a></li>
            <li><a href="#">Contato</a></li>
            <li><a href="#">Política de Privacidade</a></li>
            <li><a href="#">Termos de Uso</a></li>
          </ul>
        </div>
        
        <div class="footer-section">
          <h3 class="footer-title">Conecte-se</h3>
          <div class="social-links">
            <a href="#" class="social-link" aria-label="TikTok">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2v10.5A4.5 4.5 0 1 0 16.5 16V8h3V2h-7.5z"/>
              </svg>
            </a>
            <a href="#" class="social-link" aria-label="Twitter">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"/>
              </svg>
            </a>
            <a href="#" class="social-link" aria-label="Facebook">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M22 12a10 10 0 1 0-11.5 9.9V14.9h-2v-2.5h2v-1.9c0-2 1.2-3.1 3-3.1.9 0 1.8.1 1.8.1v2h-1c-1 0-1.3.6-1.3 1.2v1.8h2.2L18 14.9h-2v6.9A10 10 0 0 0 22 12z"/>
              </svg>
            </a>
            <a href="#" class="social-link" aria-label="YouTube">
              <svg width="20" height="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <rect x="2" y="6" width="20" height="12" rx="3" stroke="currentColor" stroke-width="1.2" fill="none"/>
                <path d="M10 9l6 3-6 3V9z" fill="currentColor"/>
              </svg>
            </a>
            <a href="#" class="social-link" aria-label="LinkedIn">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <rect x="2" y="2" width="20" height="20" rx="2" stroke="currentColor" stroke-width="1.2" fill="none"/>
                <path d="M7 9h2v8H7zM8 6.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2zM11 9h2v1.1c.3-.6 1-1.1 2-1.1 2 0 3 1.2 3 3.6V17h-2v-4c0-1-0.5-1.9-1.7-1.9-1 0-1.6.7-1.9 1.4-.1.2-.1.5-.1.8V17h-2V9z"/>
              </svg>
            </a>
          </div>
        </div>
            </a>
          </div>
        </div>
      </div>
      
      <div class="footer-bottom">
        <p>&copy; 2025 Backstage. Todos os direitos reservados.</p>
      </div>
    </div>
  </footer>

  <!-- Popup de Adicionar à Lista -->
  <div class="list-popup-overlay" id="listPopupOverlay">
    <div class="list-popup">
      <div class="popup-header">
        <h3 id="popupTitle">Adicionar à Lista</h3>
        <button class="close-popup" onclick="hideListPopup()">&times;</button>
      </div>

      <!-- Opções principais -->
      <div class="popup-content" id="popupOptions">
        <!-- Lista de listas existentes -->
        <div id="existingLists">
          <div id="loadingLists">
            Carregando suas listas...
          </div>
          <div id="listsContainer" style="display: none;">
            <!-- As listas serão carregadas aqui via JavaScript -->
          </div>
          <div id="noLists" style="display: none;">
            Você ainda não criou nenhuma lista
          </div>
        </div>

        <!-- Botões de ação -->
        <button class="popup-option create-list" onclick="showCreateListForm()">
          <span class="icon">+</span>
          <span>Criar Nova Lista</span>
        </button>
      </div>

      <!-- Formulário de criar lista -->
      <div class="popup-content" id="createListForm" style="display: none;">
        <form onsubmit="createNewList(event)">
          <div class="form-group">
            <label for="listName">Nome da Lista:</label>
            <input type="text" id="listName" placeholder="Ex: Meus Filmes Favoritos" required>
          </div>
          <div class="form-actions">
            <button type="button" onclick="showListOptions()">Voltar</button>
            <button type="submit">Criar Lista</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  {% include 'backstage/_mobile_search.html' %}
  {% include 'backstage/_mobile_bottom_nav.html' %}
  {% include 'backstage/_mobile_scripts.html' %}

    <script src="{% static 'js/intro.js' %}"></script>
    <script src="{% static 'js/main.js' %}?v=3.0" defer></script>
    <script src="{% static 'js/profile_menu.js' %}" defer></script>
    <script src="{% static 'js/search-suggestions.js' %}" defer></script>
    <script src="{% static 'js/notifications.js' %}" defer></script>
    
    <script>
    // Sistema de Lista no Hero
    document.addEventListener('DOMContentLoaded', function() {
      // Adicionar evento ao botão "Adicionar à Lista" no hero
      const heroAddBtn = document.querySelector('.hero-actions .btn-secondary');
      if (heroAddBtn) {
        heroAddBtn.addEventListener('click', function() {
          // Pegar o ID do filme atual do hero
          const heroTitle = document.querySelector('.hero-title');
          if (heroTitle) {
            const movieId = heroTitle.dataset.movieId;
            if (movieId) {
              window.currentHeroMovieId = movieId;
              loadUserLists();
              document.getElementById('listPopupOverlay').classList.add('show');
              document.body.style.overflow = 'hidden';
            }
          }
        });
      }

      // Adicionar evento ao botão "Assistir Trailer" no hero
      const heroTrailerBtn = document.querySelector('.hero-actions .btn-primary');
      if (heroTrailerBtn) {
        heroTrailerBtn.addEventListener('click', async function(event) {
          // Prevenir comportamento padrão e propagação
          event.preventDefault();
          event.stopPropagation();
          
          const heroTitle = document.querySelector('.hero-title');
          if (heroTitle) {
            const movieId = heroTitle.dataset.movieId;
            console.log('Movie ID do hero:', movieId);
            
            if (movieId) {
              try {
                // Buscar vídeos do filme
                const url = `/api/filme/${movieId}/videos/`;
                console.log('Buscando trailer em:', url);
                
                const response = await fetch(url);
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                  const errorText = await response.text();
                  console.error('Erro na resposta:', errorText);
                  alert('Não foi possível carregar o trailer.');
                  return;
                }

                const data = await response.json();
                console.log('Dados recebidos:', data);
                
                if (data.success && data.videos && data.videos.length > 0) {
                  // Procurar por trailer no YouTube
                  const trailer = data.videos.find(video => 
                    video.type === 'Trailer' && video.site === 'YouTube'
                  ) || data.videos[0];

                  console.log('Trailer encontrado:', trailer);

                  if (trailer && trailer.key) {
                    window.open(`https://www.youtube.com/watch?v=${trailer.key}`, '_blank');
                  } else {
                    alert('Trailer não disponível para este filme.');
                  }
                } else {
                  alert('Trailer não disponível para este filme.');
                }
              } catch (error) {
                console.error('Erro ao buscar trailer:', error);
                alert('Erro ao buscar trailer.');
              }
            } else {
              console.error('Movie ID não encontrado no hero-title');
              alert('ID do filme não encontrado.');
            }
          }
        });
      }
    });

    function hideListPopup() {
      document.getElementById('listPopupOverlay').classList.remove('show');
      document.body.style.overflow = '';
    }

    function showCreateListForm() {
      document.getElementById('popupOptions').style.display = 'none';
      document.getElementById('createListForm').style.display = 'block';
      document.getElementById('popupTitle').textContent = 'Criar Nova Lista';
      setTimeout(() => document.getElementById('listName').focus(), 100);
    }

    function showListOptions() {
      document.getElementById('popupOptions').style.display = 'block';
      document.getElementById('createListForm').style.display = 'none';
      document.getElementById('popupTitle').textContent = 'Adicionar à Lista';
    }

    function createNewList(event) {
      event.preventDefault();
      const name = document.getElementById('listName').value.trim();
      if (name) {
        fetch('/api/criar-lista/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({nome: name, publica: false})
        })
        .then(response => {
          if (response.status === 401) {
            window.location.href = '/login/';
            return;
          }
          return response.json();
        })
        .then(data => {
          if (!data) return;
          if (data.success) {
            alert('Lista "' + name + '" criada!');
            document.getElementById('listName').value = '';
            showListOptions();
            loadUserLists();
          } else {
            alert('Erro: ' + data.message);
          }
        });
      }
    }

    function loadUserLists() {
      const loadingEl = document.getElementById('loadingLists');
      const containerEl = document.getElementById('listsContainer');
      const noListsEl = document.getElementById('noLists');

      loadingEl.style.display = 'block';
      containerEl.style.display = 'none';
      noListsEl.style.display = 'none';

      fetch('/api/buscar-listas/?tipo=filme', {
        method: 'GET',
        headers: {
          'X-CSRFToken': getCookie('csrftoken')
        }
      })
      .then(response => {
        if (response.status === 401) {
          window.location.href = '/login/';
          return;
        }
        return response.json();
      })
      .then(data => {
        if (!data) return;
        loadingEl.style.display = 'none';

        if (data.success && data.listas.length > 0) {
          // Separar "Assistir Mais Tarde" das outras listas
          const assistirMaisTarde = data.listas.find(l => l.nome === "Assistir Mais Tarde");
          const outrasListas = data.listas.filter(l => l.nome !== "Assistir Mais Tarde");
          
          let html = '';
          
          // Adicionar "Assistir Mais Tarde" primeiro com estilo especial
          if (assistirMaisTarde) {
            html += `
              <div class="list-item list-item-featured">
                <div class="list-item-info">
                  <div class="list-item-name">${assistirMaisTarde.nome}</div>
                  <div class="list-item-meta">${assistirMaisTarde.count} filme${assistirMaisTarde.count !== 1 ? 's' : ''}</div>
                </div>
                <button class="list-item-add" onclick="addMovieToList(${assistirMaisTarde.id}, '${assistirMaisTarde.nome}')">
                  Adicionar
                </button>
              </div>
            `;
          }
          
          // Adicionar outras listas
          html += outrasListas.map(lista => `
            <div class="list-item">
              <div class="list-item-info">
                <div class="list-item-name">${lista.nome}</div>
                <div class="list-item-meta">${lista.count} filme${lista.count !== 1 ? 's' : ''}</div>
              </div>
              <button class="list-item-add" onclick="addMovieToList(${lista.id}, '${lista.nome}')">
                Adicionar
              </button>
            </div>
          `).join('');
          
          containerEl.innerHTML = html;
          containerEl.style.display = 'block';
        } else {
          noListsEl.style.display = 'block';
        }
      })
      .catch(error => {
        console.error('Erro ao carregar listas:', error);
        loadingEl.style.display = 'none';
        noListsEl.style.display = 'block';
        noListsEl.textContent = 'Erro ao carregar listas';
      });
    }

    function addMovieToList(listaId, listaNome) {
      const tmdbId = window.currentHeroMovieId;

      if (!tmdbId) {
        alert('Erro: ID do filme não encontrado');
        return;
      }

      fetch(`/api/lista/${listaId}/adicionar/${tmdbId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken')
        }
      })
      .then(response => {
        if (response.status === 401) {
          window.location.href = '/login/';
          return;
        }
        return response.json();
      })
      .then(data => {
        if (!data) return;
        if (data.success) {
          alert('Filme adicionado à lista "' + listaNome + '"!');
          loadUserLists();
          hideListPopup();
        } else {
          alert('Erro: ' + data.message);
        }
      })
      .catch(error => {
        console.error('Erro ao adicionar filme à lista:', error);
        alert('Erro ao adicionar filme à lista');
      });
    }

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    // Fechar popup clicando fora
    document.getElementById('listPopupOverlay')?.addEventListener('click', function(e) {
      if (e.target === this) {
        hideListPopup();
      }
    });
    </script>
</body>
</html>    