{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ lista.nome }} — Backstage</title>
  <link rel="icon" type="image/png" href="{% static 'images/Icone_Backstage.png' %}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/main.css' %}">
  <link rel="stylesheet" href="{% static 'css/dropdown.css' %}">
  <link rel="stylesheet" href="{% static 'css/lists.css' %}">
  <link rel="stylesheet" href="{% static 'css/mobile.css' %}">
  <style>
    .watchlist-grid {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .watchlist-item {
      display: flex;
      gap: 24px;
      background: var(--surface);
      border-radius: var(--radius-lg);
      padding: 20px;
      border: 1px solid var(--border);
      transition: all var(--transition-base);
    }

    .watchlist-item:hover {
      border-color: var(--border-hover);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .watchlist-poster {
      flex-shrink: 0;
      width: 150px;
      height: 225px;
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .watchlist-poster img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform var(--transition-base);
    }

    .watchlist-poster:hover img {
      transform: scale(1.05);
    }

    .watchlist-poster .no-poster {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-tertiary);
      color: var(--text-muted);
      font-size: 14px;
    }

    .watchlist-details {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .watchlist-header {
      display: flex;
      align-items: baseline;
      gap: 12px;
      flex-wrap: wrap;
    }

    .watchlist-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }

    .watchlist-title a {
      color: var(--text-primary);
      text-decoration: none;
      transition: color var(--transition-fast);
    }

    .watchlist-title a:hover {
      color: var(--primary);
    }

    .watchlist-year {
      font-size: 18px;
      color: var(--text-muted);
      font-weight: 500;
    }

    .watchlist-description {
      color: var(--text-secondary);
      line-height: 1.6;
      margin: 0;
    }

    .watchlist-meta {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      align-items: center;
    }

    .watchlist-genre {
      padding: 4px 12px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .watchlist-added {
      font-size: 13px;
      color: var(--text-muted);
    }

    .watchlist-actions {
      display: flex;
      gap: 12px;
      margin-top: auto;
    }

    .btn-sm {
      padding: 8px 16px;
      font-size: 14px;
    }

    @media (max-width: 768px) {
      .watchlist-item {
        flex-direction: column;
        gap: 16px;
      }

      .watchlist-poster {
        width: 100%;
        height: auto;
        aspect-ratio: 2/3;
      }

      .watchlist-title {
        font-size: 20px;
      }

      .watchlist-actions {
        flex-direction: column;
      }

      .btn-sm {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  {% include 'backstage/_mobile_header.html' %}

  <header class="site-header">
    <div class="container">
      <nav class="nav-primary">
        <a class="brand" href="{% url 'backstage:index' %}">
          <img src="{% static 'images/Logo_Backstage_branca.png' %}"
               alt="Backstage Logo"
               width="250">
        </a>

        <div class="nav-menu">
          <a href="{% url 'backstage:index' %}" class="nav-link">Início</a>
          <a href="{% url 'backstage:movies' %}" class="nav-link">Filmes</a>
          <a href="{% url 'backstage:series' %}" class="nav-link">Séries</a>
          <a href="{% url 'backstage:lists' %}" class="nav-link">Listas</a>
          <a href="{% url 'backstage:comunidade' %}" class="nav-link">Comunidade</a>
        </div>

        <div class="nav-actions">
          <form method="get" action="{% url 'backstage:buscar' %}" class="search-container">
            <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none">
              <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
              <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <input type="search" name="q" class="search-input" placeholder="Buscar filmes, séries..." autocomplete="off" />
            <input type="hidden" name="tipo" value="titulo" />
          </form>

          {% include 'backstage/_user_dropdown.html' %}
        </div>
      </nav>
    </div>
  </header>

  <main class="container">
    <!-- Lista Header -->
    <div class="list-header">
      <div class="list-header-content" style="display: flex; justify-content: space-between; align-items: center;">
        <div class="list-title-section">
          <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 29 39" fill="none" stroke="currentColor" stroke-width="2" class="list-icon">
            <path d="M1.72505 34.5051L2.05744 35.7208C2.11819 35.943 2.2334 36.1465 2.39265 36.3129C2.95883 36.9045 3.91204 36.8782 4.44466 36.2561L13.7613 25.3749C14.1532 24.9172 14.8579 24.9075 15.2622 25.3542L24.3211 35.3616C25.1134 36.2368 26.5154 36.1413 27.1816 35.1667C27.389 34.8632 27.5 34.5042 27.5 34.1366V18.3989V14.0676C27.5 12.889 27.2916 11.7196 26.8845 10.6136L26.4758 9.50293C26.0782 8.42285 25.4972 7.4195 24.7584 6.53707L24.1058 5.75772C23.7691 5.35564 23.4013 4.98067 23.0059 4.63627L22.5401 4.2307C21.9488 3.71572 21.2989 3.27209 20.6039 2.90895L20.3611 2.7821C19.4918 2.32788 18.5603 2.00403 17.5967 1.82094L16.8325 1.67575C15.9318 1.50461 15.0118 1.45815 14.0984 1.53769L12.8183 1.64917C11.9926 1.72107 11.1791 1.89534 10.3964 2.16798L9.13134 2.60864C8.16615 2.94485 7.25821 3.42703 6.43916 4.03839L6.06743 4.31586C5.62325 4.64741 5.2074 5.01531 4.82418 5.41577L4.55395 5.69815C4.03629 6.23911 3.58102 6.8365 3.19669 7.47908L3.05731 7.71213C2.45709 8.71569 2.03754 9.81675 1.81773 10.9653L1.67827 11.6939C1.55969 12.3135 1.5 12.9429 1.5 13.5737V30.6254V32.8286C1.5 33.395 1.57569 33.9588 1.72505 34.5051Z" stroke="currentColor" stroke-width="3"/>
          </svg>
          <div>
            <div style="display: flex; align-items: center; gap: 12px;">
              <h1 class="list-title">{{ lista.nome }}</h1>
              <span class="list-count">{{ itens|length }} {% if itens|length == 1 %}item{% else %}itens{% endif %}</span>
            </div>
            {% if lista.descricao %}
            <p class="list-description">{{ lista.descricao }}</p>
            {% endif %}
          </div>
        </div>
        <a href="{% url 'backstage:watchlist' %}" class="btn btn-secondary">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
          Voltar
        </a>
      </div>
    </div>

    <!-- Lista Items -->
    <div class="list-items">
      {% if itens %}
        <div class="watchlist-grid">
          {% for item in itens %}
            {% if item.filme %}
              <div class="watchlist-item">
                <a href="{% url 'backstage:detalhes_filme' item.filme.tmdb_id %}" class="watchlist-poster">
                  {% if item.filme.poster %}
                    {% if 'http' in item.filme.poster %}
                      <img src="{{ item.filme.poster }}" alt="{{ item.filme.titulo }}" loading="lazy" />
                    {% else %}
                      <img src="https://image.tmdb.org/t/p/w500{{ item.filme.poster }}" alt="{{ item.filme.titulo }}" loading="lazy" />
                    {% endif %}
                  {% else %}
                    <div class="no-poster">Sem imagem</div>
                  {% endif %}
                </a>
                <div class="watchlist-details">
                  <div class="watchlist-header">
                    <h3 class="watchlist-title">
                      <a href="{% url 'backstage:detalhes_filme' item.filme.tmdb_id %}">{{ item.filme.titulo }}</a>
                    </h3>
                    <span class="watchlist-year">{{ item.filme.data_lancamento.year|default:"—" }}</span>
                  </div>
                  {% if item.filme.descricao %}
                    <p class="watchlist-description">{{ item.filme.descricao|truncatewords:30 }}</p>
                  {% endif %}
                  <div class="watchlist-meta">
                    {% if item.filme.categoria %}
                      <span class="watchlist-genre">{{ item.filme.categoria }}</span>
                    {% endif %}
                    <span class="watchlist-added">Adicionado em {{ item.adicionado_em|date:"d/m/Y" }}</span>
                  </div>
                  <div class="watchlist-actions">
                    <a href="{% url 'backstage:detalhes_filme' item.filme.tmdb_id %}" class="btn btn-primary btn-sm">Ver Detalhes</a>
                    <button class="btn btn-secondary btn-sm" onclick="removeFromList({{ item.filme.tmdb_id }}, 'filme')">Remover</button>
                  </div>
                </div>
              </div>
            {% elif item.serie %}
              <div class="watchlist-item">
                <a href="{% url 'backstage:detalhes_serie' item.serie.tmdb_id %}" class="watchlist-poster">
                  {% if item.serie.poster %}
                    {% if 'http' in item.serie.poster %}
                      <img src="{{ item.serie.poster }}" alt="{{ item.serie.titulo }}" loading="lazy" />
                    {% else %}
                      <img src="https://image.tmdb.org/t/p/w500{{ item.serie.poster }}" alt="{{ item.serie.titulo }}" loading="lazy" />
                    {% endif %}
                  {% else %}
                    <div class="no-poster">Sem imagem</div>
                  {% endif %}
                </a>
                <div class="watchlist-details">
                  <div class="watchlist-header">
                    <h3 class="watchlist-title">
                      <a href="{% url 'backstage:detalhes_serie' item.serie.tmdb_id %}">{{ item.serie.titulo }}</a>
                    </h3>
                    <span class="watchlist-year">{{ item.serie.data_primeira_exibicao.year|default:"—" }}</span>
                  </div>
                  {% if item.serie.descricao %}
                    <p class="watchlist-description">{{ item.serie.descricao|truncatewords:30 }}</p>
                  {% endif %}
                  <div class="watchlist-meta">
                    {% if item.serie.numero_temporadas %}
                      <span class="watchlist-genre">{{ item.serie.numero_temporadas }} temporada{{ item.serie.numero_temporadas|pluralize }}</span>
                    {% endif %}
                    <span class="watchlist-added">Adicionado em {{ item.adicionado_em|date:"d/m/Y" }}</span>
                  </div>
                  <div class="watchlist-actions">
                    <a href="{% url 'backstage:detalhes_serie' item.serie.tmdb_id %}" class="btn btn-primary btn-sm">Ver Detalhes</a>
                    <button class="btn btn-secondary btn-sm" onclick="removeFromList({{ item.serie.tmdb_id }}, 'serie')">Remover</button>
                  </div>
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
      {% else %}
        <div class="empty-state">
          <svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 29 39" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M1.72505 34.5051L2.05744 35.7208C2.11819 35.943 2.2334 36.1465 2.39265 36.3129C2.95883 36.9045 3.91204 36.8782 4.44466 36.2561L13.7613 25.3749C14.1532 24.9172 14.8579 24.9075 15.2622 25.3542L24.3211 35.3616C25.1134 36.2368 26.5154 36.1413 27.1816 35.1667C27.389 34.8632 27.5 34.5042 27.5 34.1366V18.3989V14.0676C27.5 12.889 27.2916 11.7196 26.8845 10.6136L26.4758 9.50293C26.0782 8.42285 25.4972 7.4195 24.7584 6.53707L24.1058 5.75772C23.7691 5.35564 23.4013 4.98067 23.0059 4.63627L22.5401 4.2307C21.9488 3.71572 21.2989 3.27209 20.6039 2.90895L20.3611 2.7821C19.4918 2.32788 18.5603 2.00403 17.5967 1.82094L16.8325 1.67575C15.9318 1.50461 15.0118 1.45815 14.0984 1.53769L12.8183 1.64917C11.9926 1.72107 11.1791 1.89534 10.3964 2.16798L9.13134 2.60864C8.16615 2.94485 7.25821 3.42703 6.43916 4.03839L6.06743 4.31586C5.62325 4.64741 5.2074 5.01531 4.82418 5.41577L4.55395 5.69815C4.03629 6.23911 3.58102 6.8365 3.19669 7.47908L3.05731 7.71213C2.45709 8.71569 2.03754 9.81675 1.81773 10.9653L1.67827 11.6939C1.55969 12.3135 1.5 12.9429 1.5 13.5737V30.6254V32.8286C1.5 33.395 1.57569 33.9588 1.72505 34.5051Z" stroke="currentColor" stroke-width="3"/>
          </svg>
          <h2>Esta lista está vazia</h2>
          <p>Adicione filmes e séries para começar sua coleção</p>
          <a href="{% url 'backstage:movies' %}" class="btn btn-primary">Explorar Filmes</a>
        </div>
      {% endif %}
    </div>
  </main>

  {% include 'backstage/_mobile_bottom_nav.html' %}
  {% include 'backstage/_mobile_search.html' %}
  {% include 'backstage/_mobile_scripts.html' %}

  <script src="{% static 'js/profile_menu.js' %}"></script>
  <script>
    function removeFromList(tmdbId, type) {
      if (!confirm('Tem certeza que deseja remover este item da lista?')) {
        return;
      }

      const listaId = {{ lista.id }};
      const url = type === 'filme' 
        ? `/api/lista/${listaId}/remover/${tmdbId}/`
        : `/api/lista/${listaId}/remover-serie/${tmdbId}/`;

      fetch(url, {
        method: 'DELETE',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/json'
        }
      })
      .then(response => response.json())
      .then(result => {
        if (result.success) {
          alert('Item removido da lista!');
          location.reload();
        } else {
          alert('Erro ao remover item: ' + (result.message || 'Erro desconhecido'));
        }
      })
      .catch(error => {
        console.error('Erro ao remover:', error);
        alert('Erro ao remover item da lista');
      });
    }

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  </script>
</body>
{% include 'backstage/footer_default.html' %}
</html>
