<!DOCTYPE html>
<html lang="pt-br">
<head>
  {% load static %}
  {% load humanize %}
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ filme.titulo }} - Backstage</title>
  <link rel="icon" type="image/png" href="{% static 'images/Icone_Backstage.png' %}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/main.css' %}">
  <link rel="stylesheet" href="{% static 'css/movie_details.css' %}">
  <link rel="stylesheet" href="{% static 'css/dropdown.css' %}">
  <link rel="stylesheet" href="{% static 'css/mobile.css' %}">
</head>
<body>
  {% include 'backstage/_mobile_header.html' %}
  <header class="site-header">
    <div class="container">
      <nav class="nav-primary">
                <a class="brand" href="{% url 'backstage:index' %}">
            <img src="{% static 'images/Logo_Backstage_branca.png' %}"
                 alt="Backstage Logo"
                 width="250">
        </a>

        <div class="nav-menu">
          <a href="{% url 'backstage:index' %}" class="nav-link">In√≠cio</a>
          <a href="{% url 'backstage:movies' %}" class="nav-link active">Filmes</a>
          <a href="{% url 'backstage:series' %}" class="nav-link">S√©ries</a>
          <a href="{% url 'backstage:lists' %}" class="nav-link">Listas</a>
          <a href="{% url 'backstage:comunidade' %}" class="nav-link">Comunidade</a>
        </div>

        <div class="nav-actions">
          <form method="get" action="{% url 'backstage:buscar' %}" class="search-container">
            <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none">
              <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
              <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <input type="search" name="q" class="search-input" placeholder="Buscar filmes, s√©ries..." autocomplete="off" />
            <input type="hidden" name="tipo" value="titulo" />
            <div class="search-suggestions"></div>
          </form>

          {% include 'backstage/_notifications.html' %}

          {% include 'backstage/_user_dropdown.html' %}
        </div>
      </nav>
    </div>
  </header>

  <section class="movie-hero">
    <div class="movie-backdrop">
      <img src="{{ tmdb_image_base }}original{{ filme.backdrop_path|default:filme.poster_path }}" alt="{{ filme.titulo }} backdrop" />
      <div class="movie-backdrop-gradient"></div>
    </div>
    
    <div class="container movie-hero-content">
      <div class="movie-poster-section">
        <img src="{{ tmdb_image_base }}w500{{ filme.poster_path }}" alt="{{ filme.titulo }} poster" class="movie-poster" />
        <button class="trailer-btn">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
            <path d="M8 5v14l11-7z"/>
          </svg>
          Assistir Trailer
        </button>
      </div>
      
      <div class="movie-info-section" data-movie-id="{{ filme.tmdb_id }}">
        <div class="movie-header">
          <h1 class="movie-title">{{ filme.titulo }}</h1>
          <span class="movie-original-title">{{ filme.titulo }}</span>
        </div>
        
        <div class="movie-metadata">
          <span class="movie-year">{{ filme.ano_lancamento|default:"2024" }}</span>
          <span class="movie-rating">PG-13</span>
          <span class="movie-duration">{{ filme.duracao_min|default:"120" }} min</span>
          <div class="movie-genres">
            {% for genero in filme.generos %}
            <span class="genre-tag">{{ genero }}</span>
            {% empty %}
            <span class="genre-tag">G√™nero n√£o dispon√≠vel</span>
            {% endfor %}
          </div>
        </div>
        
        <div class="movie-ratings">
          <div class="rating-box imdb">
            <span class="rating-source">IMDb</span>
            <div class="rating-value">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="#f5c518">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
              <strong>{{ filme.nota_tmdb|floatformat:1|default:"8.0" }}</strong>/10
            </div>
            <span class="rating-count">2.3M votos</span>
          </div>
          
          <div class="rating-box rotten">
            <span class="rating-source">Rotten Tomatoes</span>
            <div class="rating-value">
              <span class="tomato-icon">üçÖ</span>
              <strong>87%</strong>
            </div>
            <span class="rating-count">Tomatometer</span>
          </div>
          
          <div class="rating-box metacritic">
            <span class="rating-source">Metacritic</span>
            <div class="rating-value metascore">
              <strong>74</strong>
            </div>
            <span class="rating-count">Metascore</span>
          </div>
          
          <div class="rating-box backstage">
            <span class="rating-source">Backstage</span>
            <div class="rating-value">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="#667eea">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
              {% if media_backstage %}
                <strong>{{ media_backstage }}</strong>/5
              {% else %}
                <strong>N/A</strong>
              {% endif %}
            </div>
            <span class="rating-count">{{ total_avaliacoes }} avalia√ß√µes</span>
          </div>
        </div>
        
        <div class="movie-synopsis">
          <p>{{ filme.sinopse|default:"Sinopse n√£o dispon√≠vel" }}</p>
        </div>
        
        <div class="movie-actions">
          <div class="action-buttons">
            <button class="action-btn watched" id="markAsWatchedBtn">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
              Assistido
            </button>
            <button class="action-btn list">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="3" width="18" height="18" rx="2"/>
        <path d="M7 7h10M7 12h10M7 17h5" stroke="currentColor"/>
    </svg>
    Adicionar √† Lista
</button>

<div class="list-popup-overlay" id="listPopupOverlay">
      <div class="list-popup">
          <div class="popup-header">
              <h3 id="popupTitle">Adicionar √† Lista</h3>
              <button class="close-popup" onclick="hideListPopup()">&times;</button>
          </div>

          <!-- Op√ß√µes principais -->
          <div class="popup-content" id="popupOptions">
              <!-- Lista de listas existentes -->
              <div id="existingLists">
                  <div id="loadingLists">
                      Carregando suas listas...
                  </div>
                  <div id="listsContainer" style="display: none;">
                      <!-- As listas ser√£o carregadas aqui via JavaScript -->
                  </div>
                  <div id="noLists" style="display: none;">
                      Voc√™ ainda n√£o criou nenhuma lista
                  </div>
              </div>

              <!-- Bot√µes de a√ß√£o -->
              <button class="popup-option create-list" onclick="showCreateListForm()">
                  <span class="icon">+</span>
                  <span>Criar Nova Lista</span>
              </button>
          </div>

          <!-- Formul√°rio de criar lista -->
          <div class="popup-content" id="createListForm" style="display: none;">
              <form onsubmit="createNewList(event)">
                  <div class="form-group">
                      <label for="listName">Nome da Lista:</label>
                      <input type="text" id="listName" placeholder="Ex: Meus Filmes Favoritos" required>
                  </div>
                  <div class="form-actions">
                      <button type="button" onclick="showListOptions()">Voltar</button>
                      <button type="submit">Criar Lista</button>
                  </div>
              </form>
          </div>
      </div>
  </div>

  <!-- Modal de Assistido -->
  <div class="list-popup-overlay" id="watchedPopupOverlay">
      <div class="list-popup watched-popup">
          <div class="popup-header">
              <h3 class="popup-title">Adicionar ao Di√°rio</h3>
              <button class="close-popup" onclick="hideWatchedPopup()">&times;</button>
          </div>

          <div class="popup-content">
              <!-- Card do Filme -->
              <div class="watched-movie-card" id="watchedMovieCard">
                  <img id="watchedMoviePoster" src="" alt="Poster" class="watched-poster">
                  <div class="watched-movie-info">
                      <h4 id="watchedMovieTitle">T√≠tulo do Filme</h4>
                      <p id="watchedMovieYear">2025</p>
                  </div>
              </div>

              <form id="watchedForm" onsubmit="saveWatchedMovie(event)">
                  <div class="form-group">
                      <label for="watchedDate">Data que assistiu:</label>
                      <input type="date" id="watchedDate" required>
                  </div>

                  <div class="form-group">
                      <label>Sua avalia√ß√£o: <span class="required">*</span></label>
                      <div class="star-rating-watched">
                          <button type="button" class="star-watched" data-rating="5">‚òÖ</button>
                          <button type="button" class="star-watched" data-rating="4">‚òÖ</button>
                          <button type="button" class="star-watched" data-rating="3">‚òÖ</button>
                          <button type="button" class="star-watched" data-rating="2">‚òÖ</button>
                          <button type="button" class="star-watched" data-rating="1">‚òÖ</button>
                      </div>
                      <input type="hidden" id="watchedRating" required>
                  </div>

                  <div class="form-group">
                      <label for="watchedWith">Assistido com (opcional):</label>
                      <input type="text" id="watchedWith" placeholder="Ex: Jo√£o, Maria...">
                  </div>

                  <div class="form-group">
                      <label for="watchedNotes">Review (opcional):</label>
                      <textarea id="watchedNotes" rows="4" placeholder="Escreva sua an√°lise sobre o filme..."></textarea>
                  </div>

                  <div class="form-actions">
                      <button type="button" class="btn-cancel" onclick="hideWatchedPopup()">Cancelar</button>
                      <button type="submit" class="btn-save">Salvar</button>
                  </div>
              </form>
          </div>
      </div>
  </div>
          
          <div class="user-rating">
            <span class="rating-label">Sua avalia√ß√£o:</span>
            <form class="review-input-group" method="POST" action="{% url 'backstage:salvar_critica' %}">
              {% csrf_token %}
              <input type="hidden" name="filme_id" value="{{ filme.tmdb_id }}">
              <input type="hidden" name="nota" id="rating-value" value="">

              <div class="textarea-wrapper">
                <div class="star-rating">
                  <button type="button" class="star" data-rating="1">‚òÖ</button>
                  <button type="button" class="star" data-rating="2">‚òÖ</button>
                  <button type="button" class="star" data-rating="3">‚òÖ</button>
                  <button type="button" class="star" data-rating="4">‚òÖ</button>
                  <button type="button" class="star" data-rating="5">‚òÖ</button>
                </div>

                <textarea
                  class="movie-review-text"
                  placeholder="Escreva sua resenha aqui..."
                  name="texto"
                  required
                  id="review-textarea"
                ></textarea>

                <div class="textarea-controls">
                  <div class="spoiler-checkbox-container">
                    <label class="spoiler-checkbox-label">
                      <input type="checkbox" name="tem_spoiler" id="spoiler-checkbox">
                      <span>SPOILER</span>
                    </label>
                  </div>

                  <div class="textarea-controls-right">
                    <button type="button" class="expand-review-btn" onclick="openReviewModal()" title="Expandir">
                      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/>
                      </svg>
                    </button>

                    <button type="submit" class="send-review-btn" id="inline-submit-btn">
                      Enviar
                    </button>
                  </div>
                </div>
              </div>
            </form>
          </div>

          <!-- Modal de Resenha Expandida -->
          <div class="review-modal-overlay" id="reviewModalOverlay">
            <div class="review-modal">
              <div class="review-modal-header">
                <h3>Escreva sua Resenha</h3>
                <button type="button" class="close-review-modal" onclick="closeReviewModal()">
                  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12"/>
                  </svg>
                </button>
              </div>

              <div class="review-modal-body">
                <h2 class="modal-movie-title">{{ filme.titulo }}</h2>

                <div class="modal-star-rating">
                  <span class="modal-rating-label">Sua avalia√ß√£o:</span>
                  <div class="star-rating" id="modal-star-rating">
                    <button type="button" class="star" data-rating="1">‚òÖ</button>
                    <button type="button" class="star" data-rating="2">‚òÖ</button>
                    <button type="button" class="star" data-rating="3">‚òÖ</button>
                    <button type="button" class="star" data-rating="4">‚òÖ</button>
                    <button type="button" class="star" data-rating="5">‚òÖ</button>
                  </div>
                </div>

                <div class="modal-textarea-wrapper">
                  <textarea
                    class="modal-review-text"
                    placeholder="Escreva sua resenha aqui..."
                    id="modal-review-textarea"
                  ></textarea>
                </div>

                <div class="modal-footer">
                  <div class="modal-spoiler-checkbox">
                    <label class="spoiler-checkbox-label">
                      <input type="checkbox" id="modal-spoiler-checkbox">
                      <span>SPOILER</span>
                    </label>
                  </div>

                  <button type="button" class="modal-submit-btn" onclick="submitFromModal()">
                    Enviar
                  </button>
                </div>
              </div>
            </div>
          </div>

          </div>
        </div>
      </div>
    </div>
  </section>

  <main class="container movie-details">
    <div class="tabs-nav">
      <button class="tab-btn active" data-tab="overview">Vis√£o Geral</button>
      <button class="tab-btn" data-tab="crew">Equipe</button>
      <button class="tab-btn" data-tab="cast">Elenco</button>
      <button class="tab-btn" data-tab="reviews">Cr√≠ticas</button>
      <button class="tab-btn" data-tab="media">M√≠dia</button>
      <button class="tab-btn" data-tab="similar">Similares</button>
    </div>

    <div class="tab-content active" id="overview">
      <div class="overview-grid">
        <div class="overview-main">
          <section class="crew-section">
            <div class="section-header-with-action">
              <h2 class="section-title">Equipe Principal</h2>
              <button class="crew-shortcut-btn" onclick="switchToCrewTab()">
                Ver Equipe Completa
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12l-4.58 4.59z"/>
                </svg>
              </button>
            </div>
            <div class="crew-grid">
              <!-- Crew will be populated by JavaScript with real API data -->
            </div>
          </section>

          <section class="cast-section">
            <h2 class="section-title">Elenco Principal</h2>
            <div class="cast-grid">
                {% for ator in filme.elenco_principal %}
                <div class="cast-member">
                    <div class="cast-photo-container">
                        {% if ator.foto_path %}
                        <img src="{{ tmdb_image_base }}w185{{ ator.foto_path }}" alt="{{ ator.nome }}" class="cast-photo">
                        {% else %}
                        <img src="https://ui-avatars.com/api/?name={{ ator.nome }}&background=667eea&color=fff" alt="{{ ator.nome }}" class="cast-photo">
                        {% endif %}
                    </div>
                    <div class="cast-info">
                        <span class="cast-name">{{ ator.nome }}</span>
                        <span class="cast-character">{{ ator.personagem }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
          </section>

          <section class="reviews-section">
            <div class="section-header">
              <h2 class="section-title">Cr√≠ticas dos Usu√°rios</h2>
            </div>
            
            <div class="reviews-list">
              {% for critica in criticas %}
              <article class="review-card">
                <div class="review-header">
                  <img src="https://ui-avatars.com/api/?name={{ critica.usuario.username }}&background=667eea&color=fff" alt="{{ critica.usuario.username }}" class="reviewer-avatar" />
                  <div class="reviewer-info">
                    <span class="reviewer-name">{{ critica.usuario.username }}</span>
                    <div class="review-meta">
                      <span class="review-rating">
                        {% for star in "12345" %}
                          {% if forloop.counter <= critica.nota %}‚òÖ{% else %}‚òÜ{% endif %}
                        {% endfor %}
                      </span>
                      <span class="review-date">{{ critica.criado_em|timesince }} atr√°s</span>
                      {% if critica.tem_spoiler %}
                      <span class="spoiler-badge">‚ö†Ô∏è SPOILER</span>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <p class="review-text {% if critica.tem_spoiler %}has-spoiler{% endif %}" data-original-text="{{ critica.texto }}">
                  {% if critica.tem_spoiler %}
                    <span class="spoiler-blur">{{ critica.texto }}</span>
                    <button class="show-spoiler-btn" onclick="toggleSpoiler(this)">Clique para revelar spoiler</button>
                  {% else %}
                    {{ critica.texto }}
                  {% endif %}
                </p>
                <div class="review-actions">
                  <button class="review-action like-btn {% if critica.usuario_deu_like %}liked{% endif %}"
                          data-critica-id="{{ critica.id }}"
                          onclick="toggleLike(this)">
                    üëç <span class="like-count">{{ critica.total_likes|default:0 }}</span>
                  </button>
                  <button class="review-action">üí¨ 0</button>
                </div>
              </article>
              {% empty %}
              <div class="no-reviews">
                <p>Ainda n√£o h√° cr√≠ticas para este filme. Seja o primeiro a avaliar!</p>
              </div>
              {% endfor %}
            </div>
          </section>
        </div>

        <aside class="overview-sidebar">
          <section class="movie-facts">
            <h3 class="sidebar-title">Informa√ß√µes</h3>
            <dl class="facts-list">
              {% if filme.status %}
              <dt>Status</dt>
              <dd>
                {% if filme.status == "Released" %}Lan√ßado
                {% elif filme.status == "Post Production" %}P√≥s-produ√ß√£o
                {% elif filme.status == "In Production" %}Em produ√ß√£o
                {% elif filme.status == "Planned" %}Planejado
                {% else %}{{ filme.status }}{% endif %}
              </dd>
              {% endif %}

              {% if filme.data_lancamento_formatada %}
              <dt>Data de Lan√ßamento</dt>
              <dd>{{ filme.data_lancamento_formatada }}</dd>
              {% endif %}

              {% if filme.idioma_original %}
              <dt>Idioma Original</dt>
              <dd>
                {% if filme.idioma_original == "en" %}Ingl√™s
                {% elif filme.idioma_original == "pt" %}Portugu√™s
                {% elif filme.idioma_original == "es" %}Espanhol
                {% elif filme.idioma_original == "fr" %}Franc√™s
                {% elif filme.idioma_original == "de" %}Alem√£o
                {% elif filme.idioma_original == "it" %}Italiano
                {% elif filme.idioma_original == "ja" %}Japon√™s
                {% elif filme.idioma_original == "ko" %}Coreano
                {% elif filme.idioma_original == "zh" %}Chin√™s
                {% else %}{{ filme.idioma_original|upper }}{% endif %}
              </dd>
              {% endif %}

              {% if filme.orcamento and filme.orcamento > 0 %}
              <dt>Or√ßamento</dt>
              <dd>${{ filme.orcamento|floatformat:0|intcomma }}</dd>
              {% endif %}

              {% if filme.receita and filme.receita > 0 %}
              <dt>Receita</dt>
              <dd>${{ filme.receita|floatformat:0|intcomma }}</dd>
              {% endif %}

              {% if filme.palavras_chave %}
              <dt>Palavras-chave</dt>
              <dd>
                <div class="keyword-tags">
                  {% for palavra in filme.palavras_chave %}
                  <span class="keyword-tag">{{ palavra }}</span>
                  {% endfor %}
                </div>
              </dd>
              {% endif %}
            </dl>
          </section>

          <section class="streaming-section">
            <h3 class="sidebar-title">Onde Assistir</h3>
            <div class="streaming-list">
              {% for plataforma in filme.plataformas %}
              <a href="#" class="streaming-service">
                {% if plataforma.logo_path %}
                <img src="{{ tmdb_image_base }}original{{ plataforma.logo_path }}" 
                     alt="{{ plataforma.nome }}" 
                     class="service-logo"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';">
                {% endif %}
                <span class="service-name" {% if plataforma.logo_path %}style="display:none;"{% endif %}>{{ plataforma.nome }}</span>
                <span class="service-type">
                  {% if plataforma.tipo == "flatrate" %}Streaming
                  {% elif plataforma.tipo == "rent" %}Aluguel
                  {% elif plataforma.tipo == "buy" %}Compra
                  {% elif plataforma.tipo == "ads" %}Com an√∫ncios
                  {% else %}Gr√°tis{% endif %}
                </span>
              </a>
              {% empty %}
              <p>N√£o dispon√≠vel para streaming</p>
              {% endfor %}
            </div>
          </section>

          <section class="social-stats">
            <h3 class="sidebar-title">Estat√≠sticas</h3>
            <div class="stats-list">
              <div class="stat-item">
                <span class="stat-icon">üëÅÔ∏è</span>
                <div class="stat-info">
                  <span class="stat-number">12.5K</span>
                  <span class="stat-label">Assistiram</span>
                </div>
              </div>
              <div class="stat-item">
                <span class="stat-icon">‚ù§Ô∏è</span>
                <div class="stat-info">
                  <span class="stat-number">8.3K</span>
                  <span class="stat-label">Favoritaram</span>
                </div>
              </div>
              <div class="stat-item">
                <span class="stat-icon">üìù</span>
                <div class="stat-info">
                  <span class="stat-number">2.1K</span>
                  <span class="stat-label">Cr√≠ticas</span>
                </div>
              </div>
              <div class="stat-item">
                <span class="stat-icon">üìã</span>
                <div class="stat-info">
                  <span class="stat-number">5.7K</span>
                  <span class="stat-label">Em listas</span>
                </div>
              </div>
            </div>
          </section>
        </aside>
      </div>
    </div>

    <div class="tab-content" id="crew">
      <div class="crew-full-section">
        <div class="section-header">
          <h2 class="section-title">Equipe Completa</h2>
          <span class="crew-count">Profissionais envolvidos na produ√ß√£o</span>
        </div>
        <div class="crew-grid-full">
          <!-- Complete crew will be populated by JavaScript -->
        </div>
      </div>
    </div>

    <div class="tab-content" id="cast">
      <div class="cast-full-section">
        <div class="section-header">
          <h2 class="section-title">Elenco Completo</h2>
          <span class="cast-count">Principais atores e atrizes</span>
        </div>
        <div class="cast-grid-full">
          <!-- Cast members will be populated by JavaScript based on current movie -->
        </div>
      </div>
    </div>

    <div class="tab-content" id="reviews">
      <div class="reviews-full-section">
        <div class="section-header">
          <h2 class="section-title">Cr√≠ticas dos Usu√°rios</h2>
          <div class="reviews-actions">
            <select class="reviews-filter">
              <option>Mais recentes</option>
              <option>Mais curtidas</option>
              <option>Melhor avaliadas</option>
              <option>Pior avaliadas</option>
            </select>
            <button class="btn btn-primary">Escrever Cr√≠tica</button>
          </div>
        </div>
        
        <div class="reviews-stats">
          <div class="stats-card">
            <span class="stats-number">4.2</span>
            <span class="stats-label">M√©dia geral</span>
            <div class="stats-stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</div>
          </div>
          <div class="stats-card">
            <span class="stats-number">1,247</span>
            <span class="stats-label">Total de cr√≠ticas</span>
          </div>
          <div class="stats-card">
            <span class="stats-number">89%</span>
            <span class="stats-label">Recomendaria</span>
          </div>
        </div>

        <div class="reviews-list-full">
          <!-- Reviews will be populated by JavaScript -->
        </div>
      </div>
    </div>

    <div class="tab-content" id="media">
      <div class="media-section">
        <div class="media-tabs">
          <button class="media-tab-btn active" data-media="photos">Fotos</button>
          <button class="media-tab-btn" data-media="videos">V√≠deos</button>
          <button class="media-tab-btn" data-media="posters">P√¥steres</button>
        </div>
        
        <div class="media-grid" id="photos">
          <!-- Media will be populated by JavaScript -->
        </div>
      </div>
    </div>

    <div class="tab-content" id="similar">
      <div class="similar-section-full">
        <div class="section-header">
          <h2 class="section-title">Filmes Similares</h2>
          <span class="similar-subtitle">Baseado em g√™neros e diretor</span>
        </div>
        <div class="similar-grid-full">
          <!-- Similar movies will be populated by JavaScript -->
        </div>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <div class="brand">
            <img src="{% static 'images/Logo_Backstage_branca.png' %}"
                 alt="Backstage Logo"
                 width="40" height="40">
          </div>
          <p class="footer-description">
            Sua jornada cinematogr√°fica come√ßa aqui. Entre no Backstage e registre cada frame.
          </p>
        </div>
        
        <div class="footer-section">
          <h3 class="footer-title">Explorar</h3>
          <ul class="footer-links">
            <li><a href="{% url 'backstage:index' %}">In√≠cio</a></li>
            <li><a href="{% url 'backstage:movies' %}">Filmes</a></li>
            <li><a href="{% url 'backstage:series' %}">S√©ries</a></li>
            <li><a href="{% url 'backstage:lists' %}">Listas</a></li>
            <li><a href="{% url 'backstage:comunidade' %}">Comunidade</a></li>
          </ul>
        </div>
        
        <div class="footer-section">
          <h3 class="footer-title">Suporte</h3>
          <ul class="footer-links">
            <li><a href="#">Ajuda</a></li>
            <li><a href="#">Contato</a></li>
            <li><a href="#">Pol√≠tica de Privacidade</a></li>
            <li><a href="#">Termos de Uso</a></li>
          </ul>
        </div>
        
        <div class="footer-section">
          <h3 class="footer-title">Conecte-se</h3>
          <div class="social-links">
            <a href="#" class="social-link" aria-label="TikTok">
              <svg width="20" height="20" viewBox="0 0 96 96" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect width="96" height="96" rx="21" fill="black" style="fill:black;fill-opacity:1;"/>
                <path d="M73.31 25.7456C72.785 25.4743 72.274 25.1769 71.7788 24.8545C70.3389 23.9025 69.0186 22.7808 67.8465 21.5135C64.9139 18.158 63.8186 14.7538 63.4151 12.3705H63.4313C63.0943 10.3921 63.2337 9.11214 63.2547 9.11214H49.8974V60.7624C49.8974 61.4558 49.8974 62.1412 49.8682 62.8185C49.8682 62.9027 49.8601 62.9805 49.8553 63.0712C49.8553 63.1085 49.8553 63.1474 49.8472 63.1863C49.8472 63.196 49.8472 63.2057 49.8472 63.2154C49.7064 65.0686 49.1123 66.8588 48.1173 68.4286C47.1222 69.9983 45.7566 71.2994 44.1407 72.2175C42.4565 73.1757 40.5517 73.6782 38.614 73.6757C32.3906 73.6757 27.3468 68.6011 27.3468 62.334C27.3468 56.0669 32.3906 50.9923 38.614 50.9923C39.7921 50.9912 40.9629 51.1766 42.083 51.5415L42.0992 37.9412C38.6989 37.502 35.2444 37.7722 31.9538 38.7348C28.6631 39.6975 25.6077 41.3317 22.9802 43.5343C20.678 45.5346 18.7425 47.9214 17.2608 50.5872C16.6969 51.5594 14.5695 55.4658 14.3119 61.8058C14.1499 65.4044 15.2306 69.1326 15.7458 70.6734V70.7058C16.0699 71.6132 17.3256 74.7094 19.372 77.3197C21.0221 79.4135 22.9716 81.2527 25.1579 82.7783V82.7459L25.1903 82.7783C31.6567 87.1724 38.8263 86.884 38.8263 86.884C40.0674 86.8338 44.2249 86.884 48.9463 84.6464C54.183 82.1658 57.1642 78.47 57.1642 78.47C59.0688 76.2618 60.5832 73.7452 61.6426 71.0282C62.8513 67.8509 63.2547 64.0401 63.2547 62.5171V35.1155C63.4168 35.2127 65.5749 36.6401 65.5749 36.6401C65.5749 36.6401 68.6842 38.633 73.5352 39.9309C77.0155 40.8544 81.7045 41.0488 81.7045 41.0488V27.7887C80.0615 27.9669 76.7255 27.4485 73.31 25.7456Z" fill="white" style="fill:white;fill-opacity:1;"/>
              </svg>
            </a>
            <a href="#" class="social-link" aria-label="Twitter">
              <svg width="20" height="20" viewBox="0 0 300 271" fill="black" xmlns="http://www.w3.org/2000/svg">
                <path d="m236 0h46l-101 115 118 156h-92.6l-72.5-94.8-83 94.8h-46l107-123-113-148h94.9l65.5 86.6zm-16.1 244h25.5l-165-218h-27.4z"/>
              </svg>
            </a>
            <a href="#" class="social-link" aria-label="Facebook">
              <svg width="20" height="20" viewBox="0 0 14222 14222" xmlns="http://www.w3.org/2000/svg">
                <path fill="#1877F2" d="M14222 7111c0,-3927 -3184,-7111 -7111,-7111 -3927,0 -7111,3184 -7111,7111 0,3549 2600,6491 6000,7025l0 -4969 -1806 0 0 -2056 1806 0 0 -1567c0,-1782 1062,-2767 2686,-2767 778,0 1592,139 1592,139l0 1750 -897 0c-883,0 -1159,548 -1159,1111l0 1334 1972 0 -315 2056 -1657 0 0 4969c3400,-533 6000,-3475 6000,-7025z"/>
                <path fill="white" d="M9879 9167l315 -2056 -1972 0 0 -1334c0,-562 275,-1111 1159,-1111l897 0 0 -1750c0,0 -814,-139 -1592,-139 -1624,0 -2686,984 -2686,2767l0 1567 -1806 0 0 2056 1806 0 0 4969c362,57 733,86 1111,86 378,0 749,-30 1111,-86l0 -4969 1657 0z"/>
              </svg>
            </a>
            <a href="#" class="social-link" aria-label="Instagram">
              <svg width="20" height="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" fill="url(#instagram-gradient)">
                <defs>
                  <linearGradient id="instagram-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#833ab4;stop-opacity:1" />
                    <stop offset="50%" style="stop-color:#fd1d1d;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#fcb045;stop-opacity:1" />
                  </linearGradient>
                </defs>
                <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
              </svg>
            </a>
            <a href="#" class="social-link" aria-label="YouTube">
              <svg width="20" height="20" viewBox="0 0 28.57 20" xmlns="http://www.w3.org/2000/svg">
                <g>
                  <path d="M27.9727 3.12324C27.6435 1.89323 26.6768 0.926623 25.4468 0.597366C23.2197 2.24288e-07 14.285 0 14.285 0C14.285 0 5.35042 2.24288e-07 3.12323 0.597366C1.89323 0.926623 0.926623 1.89323 0.597366 3.12324C2.24288e-07 5.35042 0 10 0 10C0 10 2.24288e-07 14.6496 0.597366 16.8768C0.926623 18.1068 1.89323 19.0734 3.12323 19.4026C5.35042 20 14.285 20 14.285 20C14.285 20 23.2197 20 25.4468 19.4026C26.6768 19.0734 27.6435 18.1068 27.9727 16.8768C28.5701 14.6496 28.5701 10 28.5701 10C28.5701 10 28.5677 5.35042 27.9727 3.12324Z" fill="#FF0000"/>
                  <path d="M11.4253 14.2854L18.8477 10.0004L11.4253 5.71533V14.2854Z" fill="white"/>
                </g>
              </svg>
            </a>
            <a href="#" class="social-link" aria-label="LinkedIn">
              <svg width="20" height="20" viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                <g transform="translate(-373.642,-318.344)">
                  <path fill="#1D8CB5" d="M583.659,328.849H419.625c-19.599,0-35.487,15.888-35.487,35.487v164.015c0,19.599,15.888,35.486,35.487,35.486h164.033c19.599,0,35.487-15.888,35.487-35.486V364.337C619.146,344.738,603.257,328.849,583.659,328.849z"/>
                  <linearGradient id="path1950_1_" gradientUnits="userSpaceOnUse" x1="-808.8727" y1="199.8918" x2="-860.5692" y2="49.2029" gradientTransform="matrix(-0.5915 0 0 -0.5915 -34.5417 412.5453)">
                    <stop offset="0" style="stop-color:#FFFFFF"/>
                    <stop offset="1" style="stop-color:#FFFFFF;stop-opacity:0"/>
                  </linearGradient>
                  <path opacity="0.7811" fill="url(#path1950_1_)" d="M557.056,338.895H446.227c-29.337,0-52.955,23.81-52.955,53.385v108.127c0.95,23.087,4.603,8.491,11.555-17.075c8.081-29.713,34.396-55.682,66.445-75.145c24.461-14.855,51.84-24.341,101.679-25.244C601.216,382.432,598.721,346.26,557.056,338.895z"/>
                </g>
                <g transform="translate(-200.55198,-393.96227)">
                  <g transform="matrix(1.018827,0,0,-1.018827,170.5996,498.03288)">
                    <path fill="#FFFFFF" d="M109.495-101.774V2.533H74.828v-104.307H109.495z M92.168,16.775c12.081,0,19.612,8.01,19.612,18.021c-0.224,10.233-7.531,18.021-19.385,18.021c-11.864,0-19.615-7.788-19.615-18.021c0-10.011,7.521-18.021,19.159-18.021H92.168L92.168,16.775z"/>
                    <path fill="#FFFFFF" d="M128.681-101.774h34.673v58.249c0,3.119,0.226,6.235,1.143,8.462c2.5,6.232,8.209,12.681,17.784,12.681c12.547,0,17.562-9.568,17.562-23.588v-55.804h34.666v59.81c0,32.039-17.1,46.946-39.913,46.946c-18.701,0-26.915-10.45-31.476-17.571h0.234V2.533h-34.673C129.141-7.253,128.681-101.774,128.681-101.774L128.681-101.774z"/>
                  </g>
                </g>
              </svg>
            </a>
          </div>
        </div>
      </div>
      
      <div class="footer-bottom">
        <p>&copy; 2024 Backstage. Todos os direitos reservados.</p>
      </div>
    </div>
  </footer>

  <!-- Passar dados do Django para o JavaScript -->
  <script id="movie-data" type="application/json">
    {
      "crew": {{ crew_data_json|safe }},
      "cast": {{ cast_data_json|safe }}
    }
  </script>
  <script>
    // Carregar dados do JSON inline
    (function() {
      try {
        const dataScript = document.getElementById('movie-data');
        const movieData = JSON.parse(dataScript.textContent);
        window.movieCrewData = movieData.crew;
        window.movieCastData = movieData.cast;
      } catch (error) {
        console.error('Erro ao carregar dados do filme:', error);
        window.movieCrewData = [];
        window.movieCastData = [];
      }
    })();
  </script>

  <script src="{% static 'js/main.js' %}" defer></script>
  <script src="{% static 'js/movie_details.js' %}" defer></script>
  <script src="{% static 'js/search-suggestions.js' %}" defer></script>
  <script src="{% static 'js/profile_menu.js' %}"></script>
  <script src="{% static 'js/notifications.js' %}" defer></script>
  
  <!-- Inicializa√ß√£o do bot√£o de trailer -->
  <script>
  (function() {
    function initTrailerButton() {
      console.log('[TRAILER INLINE] Tentando inicializar bot√£o...');
      const trailerBtn = document.querySelector('.trailer-btn');
      console.log('[TRAILER INLINE] Bot√£o encontrado:', trailerBtn);
      
      if (trailerBtn) {
        // Remover listeners antigos se existirem
        const newBtn = trailerBtn.cloneNode(true);
        trailerBtn.parentNode.replaceChild(newBtn, trailerBtn);
        
        newBtn.addEventListener('click', async function(event) {
          console.log('[TRAILER INLINE] Clique detectado!');
          event.preventDefault();
          event.stopPropagation();
          
          const movieId = {{ filme.tmdb_id }};
          console.log('[TRAILER INLINE] Movie ID:', movieId);
          
          try {
            const url = `/api/filme/${movieId}/videos/`;
            console.log('[TRAILER INLINE] Buscando:', url);
            
            const response = await fetch(url);
            const data = await response.json();
            
            console.log('[TRAILER INLINE] Dados:', data);
            
            if (data.success && data.videos && data.videos.length > 0) {
              const trailer = data.videos.find(v => v.type === 'Trailer' && v.site === 'YouTube') || data.videos[0];
              
              if (trailer && trailer.key) {
                console.log('[TRAILER INLINE] Abrindo trailer:', trailer.key);
                window.open(`https://www.youtube.com/watch?v=${trailer.key}`, '_blank');
              } else {
                alert('Trailer n√£o dispon√≠vel.');
              }
            } else {
              alert('Trailer n√£o dispon√≠vel.');
            }
          } catch (error) {
            console.error('[TRAILER INLINE] Erro:', error);
            alert('Erro ao buscar trailer.');
          }
        });
        
        console.log('[TRAILER INLINE] Evento adicionado com sucesso!');
      }
    }
    
    // Tentar m√∫ltiplas vezes para garantir que o DOM est√° pronto
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initTrailerButton);
    } else {
      initTrailerButton();
    }
    
    // Tentar novamente ap√≥s um delay
    setTimeout(initTrailerButton, 500);
    setTimeout(initTrailerButton, 1000);
  })();
  </script>
  
  <script>
  // Inicializa√ß√£o simples e direta
  document.addEventListener('DOMContentLoaded', function() {
    console.log('Django template loaded');
    
    const addToListBtn = document.querySelector('.action-btn.list');
    if (addToListBtn) {
        addToListBtn.addEventListener('click', function() {
            console.log('Button clicked');
            const popup = document.getElementById('listPopupOverlay');
            if (popup) {
                popup.classList.add('show');
                document.body.style.overflow = 'hidden';
            }
        });
    }

    // Fechar popup
    document.querySelector('.close-popup')?.addEventListener('click', function() {
        document.getElementById('listPopupOverlay').classList.remove('show');
        document.body.style.overflow = '';
    });

    // Fechar clicando fora
    document.getElementById('listPopupOverlay')?.addEventListener('click', function(e) {
        if (e.target === this) {
            this.classList.remove('show');
            document.body.style.overflow = '';
        }
    });
  });
  </script>
  <script>
  // Solu√ß√£o mais simples - ADICIONAR APENAS ESTE C√ìDIGO
    function initListPopup() {
      document.querySelector('.action-btn.list').onclick = function() {
          loadUserLists(); // Carrega listas do usu√°rio
          document.getElementById('listPopupOverlay').classList.add('show');
          document.body.style.overflow = 'hidden';
      };

      window.hideListPopup = function() {
          document.getElementById('listPopupOverlay').classList.remove('show');
          document.body.style.overflow = '';
      };

      window.showCreateListForm = function() {
          document.getElementById('popupOptions').style.display = 'none';
          document.getElementById('createListForm').style.display = 'block';
          document.getElementById('popupTitle').textContent = 'Criar Nova Lista';
          setTimeout(() => document.getElementById('listName').focus(), 100);
      };

      window.showListOptions = function() {
          document.getElementById('popupOptions').style.display = 'block';
          document.getElementById('createListForm').style.display = 'none';
          document.getElementById('popupTitle').textContent = 'Adicionar √† Lista';
      };

      window.createNewList = function(event) {
          event.preventDefault();
          const name = document.getElementById('listName').value.trim();
          if (name) {
              // Criar lista via API
              fetch('/api/criar-lista/', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                      'X-CSRFToken': getCookie('csrftoken')
                  },
                  body: JSON.stringify({nome: name, publica: false})
              })
              .then(response => {
                  // Verificar se usu√°rio n√£o est√° autenticado (status 401)
                  if (response.status === 401) {
                      window.location.href = '/login/';
                      return;
                  }
                  return response.json();
              })
              .then(data => {
                  if (!data) return; // Se redirecionou, n√£o processar

                  if (data.success) {
                      alert('Lista "${name}" criada!');
                      document.getElementById('listName').value = '';
                      showListOptions();
                      loadUserLists(); // Recarrega listas
                  } else {
                      alert('Erro: ' + data.message);
                  }
              });
          }
      };

      function loadUserLists() {
          const loadingEl = document.getElementById('loadingLists');
          const containerEl = document.getElementById('listsContainer');
          const noListsEl = document.getElementById('noLists');

          // Mostrar loading
          loadingEl.style.display = 'block';
          containerEl.style.display = 'none';
          noListsEl.style.display = 'none';

          // Buscar listas do usu√°rio
          fetch('/api/buscar-listas/?tipo=filme', {
              method: 'GET',
              headers: {
                  'X-CSRFToken': getCookie('csrftoken')
              }
          })
          .then(response => {
              // Verificar se usu√°rio n√£o est√° autenticado (status 401)
              if (response.status === 401) {
                  window.location.href = '/login/';
                  return;
              }
              return response.json();
          })
          .then(data => {
              if (!data) return; // Se redirecionou, n√£o processar

              loadingEl.style.display = 'none';

              if (data.success && data.listas.length > 0) {
                  // Separar "Assistir Mais Tarde" das outras listas
                  const assistirMaisTarde = data.listas.find(l => l.nome === "Assistir Mais Tarde");
                  const outrasListas = data.listas.filter(l => l.nome !== "Assistir Mais Tarde");
                  
                  let html = '';
                  
                  // Adicionar "Assistir Mais Tarde" primeiro com estilo especial
                  if (assistirMaisTarde) {
                      html += `
                          <div class="list-item list-item-featured">
                              <div class="list-item-info">
                                  <div class="list-item-name">${assistirMaisTarde.nome}</div>
                                  <div class="list-item-meta">${assistirMaisTarde.count} filme${assistirMaisTarde.count !== 1 ? 's' : ''}</div>
                              </div>
                              <button class="list-item-add" onclick="addMovieToList(${assistirMaisTarde.id}, '${assistirMaisTarde.nome}')">
                                  Adicionar
                              </button>
                          </div>
                      `;
                  }
                  
                  // Adicionar outras listas
                  html += outrasListas.map(lista => `
                      <div class="list-item">
                          <div class="list-item-info">
                              <div class="list-item-name">${lista.nome}</div>
                              <div class="list-item-meta">${lista.count} filme${lista.count !== 1 ? 's' : ''}</div>
                          </div>
                          <button class="list-item-add" onclick="addMovieToList(${lista.id}, '${lista.nome}')">
                              Adicionar
                          </button>
                      </div>
                  `).join('');
                  
                  containerEl.innerHTML = html;
                  containerEl.style.display = 'block';
              } else {
                  // N√£o tem listas
                  noListsEl.style.display = 'block';
              }
          })
          .catch(error => {
              console.error('Erro ao carregar listas:', error);
              loadingEl.style.display = 'none';
              noListsEl.style.display = 'block';
              noListsEl.textContent = 'Erro ao carregar listas';
          });
      }

      // Fun√ß√£o para adicionar filme a uma lista existente
      window.addMovieToList = function(listaId, listaNome) {
          const tmdbId = getCurrentMovieTMDbId();

          if (!tmdbId) {
              alert('Erro: ID do filme n√£o encontrado');
              return;
          }

          fetch(`/api/lista/${listaId}/adicionar/${tmdbId}/`, {
              method: 'POST',
              headers: {
                  'X-CSRFToken': getCookie('csrftoken')
              }
          })
          .then(response => {
              // Verificar se usu√°rio n√£o est√° autenticado (status 401)
              if (response.status === 401) {
                  window.location.href = '/login/';
                  return;
              }
              return response.json();
          })
          .then(data => {
              if (!data) return; // Se redirecionou, n√£o processar

              if (data.success) {
                  alert(`Filme adicionado √† lista "${listaNome}"!`);
                  loadUserLists(); // Recarrega listas para atualizar contadores
                  hideListPopup();
              } else {
                  alert(`Erro: ${data.message}`);
              }
          })
          .catch(error => {
              console.error('Erro ao adicionar filme √† lista:', error);
              alert('Erro ao adicionar filme √† lista');
          });
      }

      // Fun√ß√£o para obter TMDb ID da URL (mesmo que no movie_details.js)
      function getCurrentMovieTMDbId() {
          const path = window.location.pathname;
          const match = path.match(/\/filmes\/(\d+)\//);
          return match ? parseInt(match[1]) : null;
      }

      function getCookie(name) {
          let cookieValue = null;
          if (document.cookie && document.cookie !== '') {
              const cookies = document.cookie.split(';');
              for (let i = 0; i < cookies.length; i++) {
                  const cookie = cookies[i].trim();
                  if (cookie.substring(0, name.length + 1) === (name + '=')) {
                      cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                      break;
                  }
              }
          }
          return cookieValue;
      }

      // Sistema de avalia√ß√£o por estrelas movido para movie_details.js

      // Fun√ß√£o para "Assistir Mais Tarde"
      window.addToWatchLater = function() {
          const tmdbId = getCurrentMovieTMDbId();

          if (!tmdbId) {
              alert('Erro: ID do filme n√£o encontrado');
              return;
          }

          // Buscar ou criar lista "Assistir Mais Tarde" usando nova API
          fetch('/api/watch-later/', {
              method: 'GET',
              headers: {
                  'X-CSRFToken': getCookie('csrftoken')
              }
          })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  // Agora adicionar o filme √† lista (existente ou rec√©m-criada)
                  return addMovieToWatchLater(data.lista_id);
              } else {
                  alert('Erro ao acessar lista: ' + data.message);
              }
          })
          .catch(error => {
              console.error('Erro:', error);
              alert('Erro ao adicionar √† Assistir Mais Tarde');
          });
      };

      function addMovieToWatchLater(listaId) {
          const tmdbId = getCurrentMovieTMDbId();

          return fetch(`/api/lista/${listaId}/adicionar/${tmdbId}/`, {
              method: 'POST',
              headers: {
                  'X-CSRFToken': getCookie('csrftoken')
              }
          })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  alert('Filme adicionado √† "Assistir Mais Tarde"!');
                  loadUserLists(); // Recarrega listas para atualizar contadores
                  hideListPopup();
              } else {
                  alert(`Erro: ${data.message}`);
              }
          });
      }
  }

// Inicializa quando o DOM carregar
document.addEventListener('DOMContentLoaded', function() {
    initListPopup();
});
</script>

<!-- CSS para Sistema de Likes -->
<style>
  .like-btn {
    transition: all 0.3s ease;
  }

  .like-btn.liked {
    color: #3b82f6 !important;
    background: rgba(59, 130, 246, 0.1);
    border-color: rgba(59, 130, 246, 0.3);
  }

  .like-btn:hover {
    transform: scale(1.05);
  }

  .like-count {
    margin-left: 4px;
  }
</style>

<!-- CSS para Menu de Usu√°rio -->
<style>
  .user-menu {
    position: relative;
  }

  .user-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 2px solid rgba(255, 255, 255, 0.2);
    cursor: pointer;
    transition: all 0.3s ease;
    background: none;
    padding: 0;
    overflow: hidden;
  }

  .user-avatar:hover {
    border-color: var(--red);
    transform: scale(1.05);
  }

  .user-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .user-dropdown {
    position: absolute;
    top: calc(100% + 10px);
    right: 0;
    background: rgba(17, 24, 39, 0.98);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    min-width: 220px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.3s ease;
    z-index: 1000;
    backdrop-filter: blur(10px);
  }

  .user-dropdown.active {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .user-dropdown-header {
    padding: 16px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  }

  .user-dropdown-name {
    color: #ffffff;
    font-size: 14px;
    font-weight: 600;
    margin: 0 0 4px 0;
  }

  .user-dropdown-email {
    color: #9ca3af;
    font-size: 12px;
    margin: 0;
  }

  .user-dropdown-divider {
    height: 1px;
    background: rgba(255, 255, 255, 0.1);
    margin: 8px 0;
  }

  .user-dropdown-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    color: #ffffff;
    text-decoration: none;
    transition: all 0.2s ease;
    font-size: 14px;
  }

  .user-dropdown-item:hover {
    background: rgba(220, 38, 38, 0.1);
    color: var(--red);
  }

  .user-dropdown-item svg {
    width: 18px;
    height: 18px;
    stroke: currentColor;
  }

  /* Seta do dropdown */
  .user-dropdown::before {
    content: '';
    position: absolute;
    top: -6px;
    right: 12px;
    width: 12px;
    height: 12px;
    background: rgba(17, 24, 39, 0.98);
    border-left: 1px solid rgba(255, 255, 255, 0.1);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    transform: rotate(45deg);
  }
</style>

<!-- JavaScript para Toggle do Menu -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const userMenuBtn = document.getElementById('userMenuBtn');
    const userDropdown = document.getElementById('userDropdown');

    if (userMenuBtn && userDropdown) {
      // Toggle dropdown ao clicar no avatar
      userMenuBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        userDropdown.classList.toggle('active');
      });

      // Fechar dropdown ao clicar fora
      document.addEventListener('click', function(e) {
        if (!userMenuBtn.contains(e.target) && !userDropdown.contains(e.target)) {
          userDropdown.classList.remove('active');
        }
      });

      // Fechar dropdown ao pressionar ESC
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          userDropdown.classList.remove('active');
        }
      });
    }
  });
</script>

<!-- Script para Modal de Resenha -->
<script>
  // Sincronizar avalia√ß√£o por estrelas entre inline e modal
  let currentRating = 0;

  function syncStarRating() {
    const inlineStars = document.querySelectorAll('.review-input-group .star');
    const modalStars = document.querySelectorAll('#modal-star-rating .star');

    // Fun√ß√£o para atualizar estrelas
    function updateStars(stars, rating) {
      stars.forEach((star, index) => {
        if (index < rating) {
          star.classList.add('active');
        } else {
          star.classList.remove('active');
        }
      });
    }

    // Event listeners para estrelas inline
    inlineStars.forEach(star => {
      star.addEventListener('click', function() {
        currentRating = parseInt(this.dataset.rating);
        document.getElementById('rating-value').value = currentRating;
        updateStars(inlineStars, currentRating);
        updateStars(modalStars, currentRating);
      });
    });

    // Event listeners para estrelas do modal
    modalStars.forEach(star => {
      star.addEventListener('click', function() {
        currentRating = parseInt(this.dataset.rating);
        document.getElementById('rating-value').value = currentRating;
        updateStars(inlineStars, currentRating);
        updateStars(modalStars, currentRating);
      });
    });
  }

  // Abrir modal
  function openReviewModal() {
    const overlay = document.getElementById('reviewModalOverlay');
    const inlineTextarea = document.getElementById('review-textarea');
    const modalTextarea = document.getElementById('modal-review-textarea');
    const inlineCheckbox = document.getElementById('spoiler-checkbox');
    const modalCheckbox = document.getElementById('modal-spoiler-checkbox');

    // Sincronizar conte√∫do
    modalTextarea.value = inlineTextarea.value;
    modalCheckbox.checked = inlineCheckbox.checked;

    // Mostrar modal
    overlay.classList.add('show');
    document.body.style.overflow = 'hidden';

    // Focus no textarea do modal
    setTimeout(() => modalTextarea.focus(), 100);
  }

  // Fechar modal
  function closeReviewModal() {
    const overlay = document.getElementById('reviewModalOverlay');
    const inlineTextarea = document.getElementById('review-textarea');
    const modalTextarea = document.getElementById('modal-review-textarea');
    const inlineCheckbox = document.getElementById('spoiler-checkbox');
    const modalCheckbox = document.getElementById('modal-spoiler-checkbox');

    // Sincronizar conte√∫do de volta
    inlineTextarea.value = modalTextarea.value;
    inlineCheckbox.checked = modalCheckbox.checked;

    // Fechar modal
    overlay.classList.remove('show');
    document.body.style.overflow = '';
  }

  // Enviar do modal
  function submitFromModal() {
    const inlineTextarea = document.getElementById('review-textarea');
    const modalTextarea = document.getElementById('modal-review-textarea');
    const inlineCheckbox = document.getElementById('spoiler-checkbox');
    const modalCheckbox = document.getElementById('modal-spoiler-checkbox');
    const form = document.querySelector('.review-input-group');

    // Sincronizar valores
    inlineTextarea.value = modalTextarea.value;
    inlineCheckbox.checked = modalCheckbox.checked;

    // Validar
    if (!currentRating) {
      alert('Por favor, selecione uma avalia√ß√£o (estrelas)');
      return;
    }

    if (!inlineTextarea.value.trim()) {
      alert('Por favor, escreva sua resenha');
      return;
    }

    // Fechar modal e submeter form
    closeReviewModal();
    form.submit();
  }

  // Fechar modal ao clicar fora
  document.getElementById('reviewModalOverlay')?.addEventListener('click', function(e) {
    if (e.target === this) {
      closeReviewModal();
    }
  });

  // Fechar modal com ESC
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      const overlay = document.getElementById('reviewModalOverlay');
      if (overlay && overlay.classList.contains('show')) {
        closeReviewModal();
      }
    }
  });

  // Sincronizar textareas em tempo real
  document.addEventListener('DOMContentLoaded', function() {
    const inlineTextarea = document.getElementById('review-textarea');
    const modalTextarea = document.getElementById('modal-review-textarea');

    if (inlineTextarea && modalTextarea) {
      inlineTextarea.addEventListener('input', function() {
        modalTextarea.value = this.value;
      });

      modalTextarea.addEventListener('input', function() {
        inlineTextarea.value = this.value;
      });
    }

    // Inicializar sistema de estrelas
    syncStarRating();
  });

  // ===== MODAL DE ASSISTIDO =====
  document.addEventListener('DOMContentLoaded', function() {
    const watchedBtn = document.getElementById('markAsWatchedBtn');
    const watchedOverlay = document.getElementById('watchedPopupOverlay');
    const watchedForm = document.getElementById('watchedForm');
    const watchedDateInput = document.getElementById('watchedDate');
    const starsWatched = document.querySelectorAll('.star-watched');
    const watchedRatingInput = document.getElementById('watchedRating');

    // Definir data de hoje como padr√£o
    const today = new Date().toISOString().split('T')[0];
    watchedDateInput.value = today;

    // Abrir modal de assistido
    if (watchedBtn) {
      watchedBtn.addEventListener('click', function() {
        // Preencher dados do filme no modal
        const movieTitle = document.querySelector('.movie-title');
        const movieYear = document.querySelector('.movie-year');
        const moviePoster = document.querySelector('.movie-poster');
        const movieInfoSection = document.querySelector('.movie-info-section');
        
        const tmdbId = movieInfoSection ? movieInfoSection.dataset.movieId : null;
        
        if (tmdbId) {
          watchedForm.dataset.tmdbId = tmdbId;
        }

        // Preencher card do filme
        if (movieTitle) {
          document.getElementById('watchedMovieTitle').textContent = movieTitle.textContent;
        }
        
        if (movieYear) {
          document.getElementById('watchedMovieYear').textContent = movieYear.textContent;
        }
        
        if (moviePoster) {
          document.getElementById('watchedMoviePoster').src = moviePoster.src;
        }

        watchedOverlay.classList.add('show');
        document.body.style.overflow = 'hidden';
        // Esconder header
        document.querySelector('.site-header').style.display = 'none';
      });
    }

    // Sistema de estrelas para avalia√ß√£o
    starsWatched.forEach(star => {
      star.addEventListener('click', function() {
        const rating = parseInt(this.dataset.rating);
        watchedRatingInput.value = rating;
        
        // Atualizar visual das estrelas
        starsWatched.forEach(s => {
          if (parseInt(s.dataset.rating) <= rating) {
            s.classList.add('active');
          } else {
            s.classList.remove('active');
          }
        });
      });
    });
  });

  // Fun√ß√£o para fechar modal de assistido
  function hideWatchedPopup() {
    const overlay = document.getElementById('watchedPopupOverlay');
    overlay.classList.remove('show');
    document.body.style.overflow = '';
    // Mostrar header novamente
    document.querySelector('.site-header').style.display = '';
    document.getElementById('watchedForm').reset();
    document.getElementById('watchedRating').value = '';
    
    // Resetar estrelas
    document.querySelectorAll('.star-watched').forEach(s => s.classList.remove('active'));
  }

  // Fun√ß√£o para salvar filme como assistido
  function saveWatchedMovie(event) {
    event.preventDefault();
    
    const form = event.target;
    const tmdbId = form.dataset.tmdbId;
    const date = document.getElementById('watchedDate').value;
    const rating = document.getElementById('watchedRating').value;
    const watchedWith = document.getElementById('watchedWith').value.trim();
    const notes = document.getElementById('watchedNotes').value.trim();

    if (!rating) {
      alert('Por favor, selecione uma avalia√ß√£o');
      return;
    }

    const data = {
      filme_id: tmdbId,
      data: date,
      nota: parseInt(rating),
      assistido_com: watchedWith || '',
      notas: notes || ''
    };

    fetch('/api/diario/adicionar/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        alert('Filme adicionado ao di√°rio!');
        hideWatchedPopup();
      } else {
        alert('Erro: ' + (data.message || 'N√£o foi poss√≠vel adicionar o filme'));
      }
    })
    .catch(error => {
      console.error('Erro:', error);
      alert('Erro ao adicionar filme ao di√°rio');
    });
  }

  // Fechar modal clicando fora
  document.getElementById('watchedPopupOverlay')?.addEventListener('click', function(e) {
    if (e.target === this) {
      hideWatchedPopup();
    }
  });
</script>

{% include 'backstage/_mobile_search.html' %}
{% include 'backstage/_mobile_bottom_nav.html' %}
{% include 'backstage/_mobile_scripts.html' %}
</body>
</html>