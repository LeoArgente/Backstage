{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ serie.titulo }} ‚Äî Backstage</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/main.css' %}">
  <link rel="stylesheet" href="{% static 'css/series_details.css' %}">
</head>
<body>
  <header class="site-header">
    <div class="container">
      <nav class="nav-primary">
        <a class="brand" href="{% url 'backstage:index' %}">
            <img src="{% static 'images/Logo_Backstage_branca.png' %}"
                 alt="Backstage Logo"
                 width="40" height="40">
            <span class="brand-text">&nbsp;</span>
        </a>

        <div class="nav-menu">
          <a href="{% url 'backstage:index' %}" class="nav-link">In√≠cio</a>
          <div class="nav-link-wrapper">
            <a href="{% url 'backstage:noticias' %}" class="nav-link">Not√≠cias</a>
            <div class="news-dropdown">
              <div class="dropdown-header">
                <h3>√öltimas Not√≠cias</h3>
                <a href="{% url 'backstage:noticias' %}" class="view-all">Ver todas</a>
              </div>
              <div class="news-dropdown-content">
                <!-- News items will be populated by JS -->
              </div>
            </div>
          </div>
          <a href="{% url 'backstage:movies' %}" class="nav-link">Filmes</a>
          <a href="{% url 'backstage:series' %}" class="nav-link active">S√©ries</a>
          <a href="{% url 'backstage:lists' %}" class="nav-link">Listas</a>
          <a href="{% url 'backstage:comunidade' %}" class="nav-link">Comunidade</a>
        </div>

        <div class="nav-actions">
          <div class="search-container">
            <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none">
              <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2"/>
              <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <input type="search" class="search-input" placeholder="Buscar s√©ries..." />
          </div>

          <button class="icon-btn notification-btn" aria-label="Notifica√ß√µes">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="M12 2a7 7 0 0 1 7 7c0 5.25 1.5 6.75 1.5 6.75H3.5S5 14.25 5 9a7 7 0 0 1 7-7z" stroke="currentColor" stroke-width="2"/>
              <path d="M10.5 19a1.5 1.5 0 0 0 3 0" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <span class="notification-badge">3</span>
          </button>

          <div class="user-menu">
            <button class="user-avatar">
              <img src="https://ui-avatars.com/api/?name=User&background=667eea&color=fff&bold=true" alt="Avatar" />
            </button>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <section class="movie-hero">
    <div class="movie-backdrop">
      <img src="{{ tmdb_image_base }}original{{ serie.backdrop_path|default:serie.poster_path }}" alt="{{ serie.titulo }} backdrop" />
      <div class="movie-backdrop-gradient"></div>
    </div>
    
    <div class="container movie-hero-content">
      <div class="movie-poster-section">
        <img src="{{ tmdb_image_base }}w500{{ serie.poster_path }}" alt="{{ serie.titulo }} poster" class="movie-poster" />
        <button class="trailer-btn">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
            <path d="M8 5v14l11-7z"/>
          </svg>
          Assistir Trailer
        </button>
      </div>
      
      <div class="series-info-section" data-serie-id="{{ serie.tmdb_id }}">
        <div class="movie-header">
          <h1 class="movie-title">{{ serie.titulo }}</h1>
          <span class="movie-original-title">{{ serie.titulo_original }}</span>
        </div>
        
        <div class="movie-metadata">
          <span class="movie-year">{{ serie.data_primeira_exibicao|date:"Y"|default:"2024" }}</span>
          <span class="series-seasons">{{ serie.numero_temporadas }} Temporada{{ serie.numero_temporadas|pluralize:"s" }}</span>
          <span class="series-episodes">{{ serie.numero_episodios }} Epis√≥dio{{ serie.numero_episodios|pluralize:"s" }}</span>
          <span class="series-status">{{ serie.status }}</span>
          <div class="movie-genres">
            {% for genero in serie.generos %}
            <span class="genre-tag">{{ genero }}</span>
            {% empty %}
            <span class="genre-tag">G√™nero n√£o dispon√≠vel</span>
            {% endfor %}
          </div>
        </div>
        
        <div class="movie-ratings">
          <div class="rating-box imdb">
            <span class="rating-source">IMDb</span>
            <div class="rating-value">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="#f5c518">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
              <strong>{{ serie.nota_tmdb|floatformat:1|default:"8.0" }}</strong>/10
            </div>
            <span class="rating-count">{{ serie.votos|default:"0" }} votos</span>
          </div>
          
          <div class="rating-box backstage">
            <span class="rating-source">Backstage</span>
            <div class="rating-value">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="#667eea">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
              <strong>4.5</strong>/5
            </div>
            <span class="rating-count">{{ criticas.count }} avalia√ß√µes</span>
          </div>
        </div>
        
        <div class="movie-synopsis">
          <p>{{ serie.sinopse|default:"Sinopse n√£o dispon√≠vel" }}</p>
        </div>
        
        <div class="movie-actions">
          <div class="action-buttons">
            <button class="action-btn watched">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
              Assistido
            </button>
            <button class="action-btn watchlist">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 2v20M5 12h14"/>
              </svg>
              Quero Ver
            </button>
            <button class="action-btn favorite">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
              </svg>
              Favoritar
            </button>
            <button class="action-btn list">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2"/>
                <path d="M7 7h10M7 12h10M7 17h5" stroke="currentColor"/>
              </svg>
              Adicionar √† Lista
            </button>
          </div>
          
          <div class="user-rating">
            <span class="rating-label">Sua avalia√ß√£o:</span>
            <div class="star-rating">
              <button class="star" data-rating="1">‚òÖ</button>
              <button class="star" data-rating="2">‚òÖ</button>
              <button class="star" data-rating="3">‚òÖ</button>
              <button class="star" data-rating="4">‚òÖ</button>
              <button class="star" data-rating="5">‚òÖ</button>
            </div>
            <form class="review-input-group" method="POST" action="{% url 'backstage:salvar_critica_serie' %}">
              {% csrf_token %}
              <input type="hidden" name="serie_id" value="{{ serie.tmdb_id }}">
              <input type="hidden" name="nota" id="rating-value" value="">
              <textarea 
                class="movie-review-text" 
                placeholder="Escreva sua cr√≠tica aqui..."
                name="texto"
                required
              ></textarea>
              <div class="spoiler-checkbox-container">
                <label class="spoiler-checkbox-label">
                  <input type="checkbox" name="tem_spoiler" id="spoiler-checkbox">
                  <span>üö® SPOILER</span>
                </label>
              </div>
              <button type="submit" class="send-review-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                </svg>
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Modal Adicionar √† Lista -->
  <div class="list-popup-overlay" id="listPopupOverlay">
    <div class="list-popup">
      <div class="popup-header">
        <h3 id="popupTitle">Adicionar √† Lista</h3>
        <button class="close-popup" onclick="hideListPopup()">&times;</button>
      </div>

      <!-- Op√ß√µes principais -->
      <div class="popup-content" id="popupOptions">
        <!-- Lista de listas existentes -->
        <div id="existingLists" style="margin-bottom: 1rem;">
          <div id="loadingLists" style="color: #888; text-align: center; padding: 1rem;">
            Carregando suas listas...
          </div>
          <div id="listsContainer" style="display: none;">
            <!-- As listas ser√£o carregadas aqui via JavaScript -->
          </div>
          <div id="noLists" style="display: none; color: #888; text-align: center; padding: 1rem;">
            Voc√™ ainda n√£o criou nenhuma lista
          </div>
        </div>

        <!-- Bot√µes de a√ß√£o -->
        <button class="popup-option create-list" onclick="showCreateListForm()">
          <span class="icon">+</span>
          <span>Criar Nova Lista</span>
        </button>
        <button class="popup-option watch-later" onclick="addToWatchLater()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="12 6 12 12 16 14"/>
          </svg>
          <span>Assistir Mais Tarde</span>
        </button>
      </div>

      <!-- Formul√°rio de criar lista -->
      <div class="popup-content" id="createListForm" style="display: none;">
        <form onsubmit="createNewList(event)">
          <div class="form-group">
            <label for="listName">Nome da Lista:</label>
            <input type="text" id="listName" placeholder="Ex: Minhas S√©ries Favoritas" required>
          </div>
          <div class="form-actions">
            <button type="button" onclick="showListOptions()">Voltar</button>
            <button type="submit">Criar Lista</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <main class="container movie-details">
    <div class="tabs-nav">
      <button class="tab-btn active" data-tab="overview">Vis√£o Geral</button>
      <button class="tab-btn" data-tab="seasons">Temporadas</button>
      <button class="tab-btn" data-tab="crew">Equipe</button>
      <button class="tab-btn" data-tab="cast">Elenco</button>
      <button class="tab-btn" data-tab="reviews">Cr√≠ticas</button>
    </div>

    <div class="tab-content active" id="overview">
      <div class="overview-grid">
        <div class="overview-main">
          <section class="crew-section">
            <h2 class="section-title">Criadores</h2>
            <div class="crew-grid">
              {% for criador in serie.criadores %}
              <div class="crew-member">
                <span class="crew-role">Criador</span>
                <span class="crew-name">{{ criador }}</span>
              </div>
              {% empty %}
              <p>Informa√ß√µes de criadores n√£o dispon√≠veis</p>
              {% endfor %}
            </div>
          </section>

          <section class="cast-section">
            <h2 class="section-title">Elenco Principal</h2>
            <div class="cast-grid" id="overview-cast-grid">
              {% for ator in serie.elenco_principal %}
              <div class="cast-member">
                {% if ator.foto_path %}
                <img src="{{ tmdb_image_base }}w185{{ ator.foto_path }}" alt="{{ ator.nome }}" class="cast-photo" />
                {% else %}
                <img src="https://ui-avatars.com/api/?name={{ ator.nome }}&background=667eea&color=fff" alt="{{ ator.nome }}" class="cast-photo" />
                {% endif %}
                <div class="cast-info">
                  <span class="cast-name">{{ ator.nome }}</span>
                  <span class="cast-character">{{ ator.personagem }}</span>
                </div>
              </div>
              {% empty %}
              <p>Elenco n√£o dispon√≠vel</p>
              {% endfor %}
            </div>
          </section>

          <section class="reviews-section">
            <div class="section-header">
              <h2 class="section-title">Cr√≠ticas dos Usu√°rios</h2>
            </div>
            
            <div class="reviews-list">
              {% for critica in criticas %}
              <article class="review-card">
                <div class="review-header">
                  <img src="https://ui-avatars.com/api/?name={{ critica.usuario.username }}&background=667eea&color=fff" alt="{{ critica.usuario.username }}" class="reviewer-avatar" />
                  <div class="reviewer-info">
                    <span class="reviewer-name">{{ critica.usuario.username }}</span>
                    <div class="review-meta">
                      <span class="review-rating">
                        {% for star in "12345" %}
                          {% if forloop.counter <= critica.nota %}‚òÖ{% else %}‚òÜ{% endif %}
                        {% endfor %}
                      </span>
                      <span class="review-date">{{ critica.criado_em|timesince }} atr√°s</span>
                    </div>
                  </div>
                </div>
                <p class="review-text">{{ critica.texto }}</p>
              </article>
              {% empty %}
              <div class="no-reviews">
                <p>Ainda n√£o h√° cr√≠ticas para esta s√©rie. Seja o primeiro a avaliar!</p>
              </div>
              {% endfor %}
            </div>
          </section>
        </div>

        <aside class="overview-sidebar">
          <section class="movie-facts">
            <h3 class="sidebar-title">Informa√ß√µes</h3>
            <dl class="facts-list">
              <dt>Status</dt>
              <dd>{{ serie.status }}</dd>
              
              <dt>Rede Original</dt>
              <dd>
                {% for rede in serie.redes %}
                  {{ rede }}{% if not forloop.last %}, {% endif %}
                {% empty %}
                  N√£o dispon√≠vel
                {% endfor %}
              </dd>
              
              <dt>Primeira Exibi√ß√£o</dt>
              <dd>{{ serie.data_primeira_exibicao|date:"d/m/Y"|default:"N√£o dispon√≠vel" }}</dd>
              
              <dt>√öltima Exibi√ß√£o</dt>
              <dd>{{ serie.data_ultima_exibicao|date:"d/m/Y"|default:"Em exibi√ß√£o" }}</dd>
              
              <dt>Total de Epis√≥dios</dt>
              <dd>{{ serie.numero_episodios }} epis√≥dios</dd>
              
              <dt>Temporadas</dt>
              <dd>{{ serie.numero_temporadas }} temporadas</dd>
            </dl>
          </section>

          <section class="social-stats">
            <h3 class="sidebar-title">Estat√≠sticas</h3>
            <div class="stats-list">
              <div class="stat-item">
                <span class="stat-icon">üëÅÔ∏è</span>
                <div class="stat-info">
                  <span class="stat-number">0</span>
                  <span class="stat-label">Assistiram</span>
                </div>
              </div>
              <div class="stat-item">
                <span class="stat-icon">‚ù§Ô∏è</span>
                <div class="stat-info">
                  <span class="stat-number">0</span>
                  <span class="stat-label">Favoritaram</span>
                </div>
              </div>
              <div class="stat-item">
                <span class="stat-icon">üìù</span>
                <div class="stat-info">
                  <span class="stat-number">{{ criticas.count }}</span>
                  <span class="stat-label">Cr√≠ticas</span>
                </div>
              </div>
            </div>
          </section>
        </aside>
      </div>
    </div>

    <div class="tab-content" id="seasons">
      <div class="temporadas-section">
        <div class="section-header">
          <h2 class="section-title">Temporadas</h2>
          <span class="season-count">{{ serie.numero_temporadas }} temporadas ‚Ä¢ {{ serie.numero_episodios }} epis√≥dios</span>
        </div>
        
        <div class="seasons-list" id="seasons-list">
          <!-- Ser√° preenchido via JavaScript -->
        </div>
      </div>
    </div>

    <div class="tab-content" id="crew">
      <div class="crew-full-section">
        <div class="section-header">
          <h2 class="section-title">Equipe Completa</h2>
        </div>
        <div class="crew-grid-full">
          {% for membro in serie.equipe %}
          <div class="crew-card-full">
            <div class="crew-info-full">
              <h4 class="crew-name-full">{{ membro.nome }}</h4>
              <p class="crew-role-full">{{ membro.cargo }}</p>
            </div>
          </div>
          {% empty %}
          <p>Informa√ß√µes da equipe n√£o dispon√≠veis</p>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="tab-content" id="cast">
      <div class="cast-full-section">
        <div class="section-header">
          <h2 class="section-title">Elenco Completo</h2>
        </div>
        <div class="cast-grid-full">
          {% for ator in serie.elenco_principal %}
          <div class="cast-card">
            {% if ator.foto_path %}
            <img src="{{ tmdb_image_base }}w185{{ ator.foto_path }}" alt="{{ ator.nome }}" />
            {% else %}
            <img src="https://ui-avatars.com/api/?name={{ ator.nome }}&background=667eea&color=fff" alt="{{ ator.nome }}" />
            {% endif %}
            <div class="cast-info">
              <span class="actor-name">{{ ator.nome }}</span>
              <span class="character-name">{{ ator.personagem }}</span>
            </div>
          </div>
          {% empty %}
          <p>Elenco n√£o dispon√≠vel</p>
          {% endfor %}
        </div>
      </div>
    </div>

    <div class="tab-content" id="reviews">
      <div class="reviews-full-section">
        <div class="section-header">
          <h2 class="section-title">Cr√≠ticas dos Usu√°rios</h2>
        </div>
        
        <div class="reviews-list-full">
          {% for critica in criticas %}
          <article class="review-card">
            <div class="review-header">
              <img src="https://ui-avatars.com/api/?name={{ critica.usuario.username }}&background=667eea&color=fff" alt="{{ critica.usuario.username }}" class="reviewer-avatar" />
              <div class="reviewer-info">
                <span class="reviewer-name">{{ critica.usuario.username }}</span>
                <div class="review-meta">
                  <span class="review-rating">
                    {% for star in "12345" %}
                      {% if forloop.counter <= critica.nota %}‚òÖ{% else %}‚òÜ{% endif %}
                    {% endfor %}
                  </span>
                  <span class="review-date">{{ critica.criado_em|timesince }} atr√°s</span>
                </div>
              </div>
            </div>
            <p class="review-text">{{ critica.texto }}</p>
          </article>
          {% empty %}
          <div class="no-reviews">
            <p>Ainda n√£o h√° cr√≠ticas para esta s√©rie.</p>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <div class="brand">
            <span class="logo">
              <svg viewBox="0 0 24 24" width="24" height="24">
                <circle cx="12" cy="12" r="10" fill="url(#footer-gradient)" opacity="0.9"/>
                <path d="M9 8v8l7-4z" fill="white"/>
                <defs>
                  <linearGradient id="footer-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#667eea"/>
                    <stop offset="100%" style="stop-color:#764ba2"/>
                  </linearGradient>
                </defs>
              </svg>
            </span>
            <span class="brand-text">&nbsp;</span>
          </div>
          <p class="footer-description">
            Sua jornada cinematogr√°fica come√ßa aqui. Entre no Backstage e registre cada frame.
          </p>
        </div>
        
        <div class="footer-section">
          <h3 class="footer-title">Explorar</h3>
          <ul class="footer-links">
            <li><a href="{% url 'backstage:index' %}">In√≠cio</a></li>
            <li><a href="{% url 'backstage:movies' %}">Filmes</a></li>
            <li><a href="{% url 'backstage:series' %}">S√©ries</a></li>
            <li><a href="{% url 'backstage:lists' %}">Listas</a></li>
            <li><a href="{% url 'backstage:comunidade' %}">Comunidade</a></li>
          </ul>
        </div>
      </div>
      
      <div class="footer-bottom">
        <p>&copy; 2024 Backstage. Todos os direitos reservados.</p>
      </div>
    </div>
  </footer>

  <!-- Dados da s√©rie para JavaScript -->
  <script>
    window.serieData = {
      tmdbId: {{ serie.tmdb_id }},
      temporadas: {{ temporadas_json|safe }},
      videos: {{ videos_json|safe }}
    };
  </script>

  <!-- JavaScript para Modal de Listas -->
  <script>
    function initListPopup() {
      const listBtn = document.querySelector('.action-btn.list');
      if (!listBtn) return;

      listBtn.onclick = function() {
        loadUserLists();
        document.getElementById('listPopupOverlay').classList.add('show');
        document.body.style.overflow = 'hidden';
      };

      window.hideListPopup = function() {
        document.getElementById('listPopupOverlay').classList.remove('show');
        document.body.style.overflow = '';
      };

      window.showCreateListForm = function() {
        document.getElementById('popupOptions').style.display = 'none';
        document.getElementById('createListForm').style.display = 'block';
        document.getElementById('popupTitle').textContent = 'Criar Nova Lista';
        setTimeout(() => document.getElementById('listName').focus(), 100);
      };

      window.showListOptions = function() {
        document.getElementById('popupOptions').style.display = 'block';
        document.getElementById('createListForm').style.display = 'none';
        document.getElementById('popupTitle').textContent = 'Adicionar √† Lista';
      };

      window.createNewList = function(event) {
        event.preventDefault();
        const name = document.getElementById('listName').value.trim();
        if (name) {
          fetch('/api/criar-lista/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({nome: name, publica: false})
          })
          .then(response => {
            if (response.status === 401) {
              window.location.href = '/login/';
              return;
            }
            return response.json();
          })
          .then(data => {
            if (!data) return;
            if (data.success) {
              alert(`Lista "${name}" criada!`);
              document.getElementById('listName').value = '';
              showListOptions();
              loadUserLists();
            } else {
              alert('Erro: ' + data.message);
            }
          });
        }
      };

      function loadUserLists() {
        const loadingEl = document.getElementById('loadingLists');
        const containerEl = document.getElementById('listsContainer');
        const noListsEl = document.getElementById('noLists');

        loadingEl.style.display = 'block';
        containerEl.style.display = 'none';
        noListsEl.style.display = 'none';

        fetch('/api/buscar-listas/', {
          method: 'GET',
          headers: {
            'X-CSRFToken': getCookie('csrftoken')
          }
        })
        .then(response => {
          if (response.status === 401) {
            window.location.href = '/login/';
            return;
          }
          return response.json();
        })
        .then(data => {
          if (!data) return;
          loadingEl.style.display = 'none';

          if (data.success && data.listas.length > 0) {
            containerEl.innerHTML = data.listas.map(lista => `
              <div class="list-item">
                <div class="list-item-info">
                  <div class="list-item-name">${lista.nome}</div>
                  <div class="list-item-meta">${lista.count} item${lista.count !== 1 ? 's' : ''}</div>
                </div>
                <button class="list-item-add" onclick="addSerieToList(${lista.id}, '${lista.nome}')">
                  Adicionar
                </button>
              </div>
            `).join('');
            containerEl.style.display = 'block';
          } else {
            noListsEl.style.display = 'block';
          }
        })
        .catch(error => {
          console.error('Erro ao carregar listas:', error);
          loadingEl.style.display = 'none';
          noListsEl.style.display = 'block';
          noListsEl.textContent = 'Erro ao carregar listas';
        });
      }

      window.addSerieToList = function(listaId, listaNome) {
        const tmdbId = getCurrentSerieTMDbId();
        if (!tmdbId) {
          alert('Erro: ID da s√©rie n√£o encontrado');
          return;
        }

        fetch(`/api/lista/${listaId}/adicionar-serie/${tmdbId}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken')
          }
        })
        .then(response => {
          if (response.status === 401) {
            window.location.href = '/login/';
            return;
          }
          return response.json();
        })
        .then(data => {
          if (!data) return;
          if (data.success) {
            alert(`S√©rie adicionada √† lista "${listaNome}"!`);
            hideListPopup();
          } else {
            alert(`Erro: ${data.message}`);
          }
        })
        .catch(error => {
          console.error('Erro ao adicionar s√©rie √† lista:', error);
          alert('Erro ao adicionar s√©rie √† lista');
        });
      };

      window.addToWatchLater = function() {
        const tmdbId = getCurrentSerieTMDbId();
        if (!tmdbId) {
          alert('Erro: ID da s√©rie n√£o encontrado');
          return;
        }

        fetch('/api/watch-later/', {
          method: 'GET',
          headers: {
            'X-CSRFToken': getCookie('csrftoken')
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            return addSerieToWatchLater(data.lista_id);
          } else {
            alert('Erro ao acessar lista: ' + data.message);
          }
        })
        .catch(error => {
          console.error('Erro:', error);
          alert('Erro ao adicionar √† Assistir Mais Tarde');
        });
      };

      function addSerieToWatchLater(listaId) {
        const tmdbId = getCurrentSerieTMDbId();

        return fetch(`/api/lista/${listaId}/adicionar-serie/${tmdbId}/`, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken')
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('S√©rie adicionada √† "Assistir Mais Tarde"!');
            hideListPopup();
          } else {
            alert(`Erro: ${data.message}`);
          }
        });
      }

      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      initListPopup();
    });
  </script>

  <script src="{% static 'js/main.js' %}" defer></script>
  <script src="{% static 'js/series_details.js' %}" defer></script>
</body>
</html>